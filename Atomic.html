<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>IPHILINI | Contrast v6.3</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #020617; font-family: 'Inter', sans-serif; color: #f1f5f9; -webkit-tap-highlight-color: transparent; }
        .glass-panel { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(12px); border-right: 1px solid #1e293b; }
        #tooltip-desktop { position: absolute; pointer-events: none; display: none; background: #1e293b; border: 1px solid #3b82f6; color: white; padding: 10px; border-radius: 8px; font-size: 12px; z-index: 1000; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        #tooltip-mobile { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #1e293b; padding: 12px 24px; border-radius: 30px; border: 2px solid #3b82f6; display: none; text-align: center; z-index: 900; width: 85%; }
        .mobile-drawer { transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .drawer-open { transform: translateY(0) !important; }
        .btn-primary { background: #2563eb; color: white; font-weight: 800; border-radius: 12px; transition: all 0.2s; }
        .btn-primary:hover { background: #3b82f6; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4); }
        input, select { background: #0f172a; color: white; border: 1px solid #334155; border-radius: 8px; padding: 8px; }
    </style>
</head>
<body class="flex flex-col md:flex-row h-screen w-screen">

    <div id="tooltip-desktop" class="hidden md:block"></div>
    <div id="tooltip-mobile" class="md:hidden">
        <div id="tm-time" class="text-xl font-black text-white">--:--</div>
        <div id="tm-date" class="text-[10px] text-blue-400 uppercase font-bold tracking-widest">Вибрати цей час</div>
    </div>

    <div class="fixed top-0 left-0 right-0 p-4 flex justify-between items-center z-50 md:hidden pointer-events-none">
        <div class="pointer-events-auto bg-slate-900/90 p-2 px-4 rounded-full border border-blue-500/30">
            <span class="text-[10px] font-black tracking-widest text-blue-400 uppercase">Iphilini Now</span>
            <div id="live-clock-mobile" class="text-sm font-mono font-bold text-white">--:--:--</div>
        </div>
        <button onclick="toggleDrawer()" class="pointer-events-auto bg-blue-600 p-3 rounded-full shadow-lg">
            <svg width="24" height="24" fill="none" stroke="white" stroke-width="2.5" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h16"></path></svg>
        </button>
    </div>

    <aside id="main-sidebar" class="mobile-drawer fixed inset-x-0 bottom-0 h-[70vh] md:relative md:h-screen md:w-80 md:translate-y-0 transform translate-y-full glass-panel z-40 flex flex-col shadow-2xl rounded-t-[32px] md:rounded-none">
        
        <div class="w-full flex justify-center p-3 md:hidden" onclick="toggleDrawer()">
            <div class="w-16 h-1.5 bg-slate-700 rounded-full"></div>
        </div>

        <div class="p-6 border-b border-slate-800 hidden md:block">
            <h1 class="text-xl font-black italic tracking-tighter text-white uppercase">IPHILINI <span class="text-blue-500 text-xs">6.3</span></h1>
            <div id="live-clock-desktop" class="text-xs font-mono text-blue-400 font-bold mt-2 tracking-widest"></div>
        </div>

        <div class="p-4 space-y-4">
            <button onclick="window.openModal({start: new Date(), end: new Date(Date.now()+3600000)})" class="w-full btn-primary py-4 text-sm uppercase tracking-widest flex items-center justify-center gap-2">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4"></path></svg>
                Створити подію
            </button>

            <div class="grid grid-cols-2 gap-3">
                <div class="flex flex-col">
                    <span class="text-[9px] font-bold text-slate-500 uppercase mb-1">Висота витка</span>
                    <input id="in-height-pct" type="number" value="220" class="text-xs font-bold p-2">
                </div>
                <div class="flex flex-col">
                    <span class="text-[9px] font-bold text-slate-500 uppercase mb-1">К-сть днів</span>
                    <input id="in-days" type="number" value="30" class="text-xs font-bold p-2">
                </div>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto px-4 bg-slate-900/20">
            <h3 class="text-[10px] font-black text-slate-600 uppercase tracking-[0.2em] my-4 text-center">Розклад</h3>
            <div id="sidebar-event-list" class="space-y-2 pb-24 md:pb-6"></div>
        </div>
    </aside>

    <div id="event-modal" class="fixed inset-0 md:left-80 md:w-96 bg-slate-950/98 z-[2000] transform translate-y-full md:translate-y-0 md:-translate-x-full transition-transform duration-300 hidden flex-col p-8 border-r border-slate-800">
        <h2 class="text-xl font-black uppercase text-blue-500 mb-8 italic">Редагувати час</h2>
        <div class="space-y-6 flex-1 overflow-y-auto">
            <div class="space-y-1">
                <label class="text-[10px] font-bold text-slate-500 uppercase">Назва</label>
                <input id="ev-summary" type="text" placeholder="Що плануєте?" class="w-full p-4 text-lg font-bold">
            </div>
            <div class="grid grid-cols-1 gap-4">
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-500 uppercase text-blue-400">Початок</label>
                    <input id="ev-start" type="datetime-local" class="w-full p-3 font-mono">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-500 uppercase text-red-400">Кінець</label>
                    <input id="ev-end" type="datetime-local" class="w-full p-3 font-mono">
                </div>
            </div>
            <div class="flex gap-4 items-end">
                <div class="flex-1 space-y-1">
                    <label class="text-[10px] font-bold text-slate-500 uppercase">Колір</label>
                    <input id="ev-color" type="color" value="#3b82f6" class="w-full h-12 p-1">
                </div>
                <div class="flex-1 space-y-1">
                    <label class="text-[10px] font-bold text-slate-500 uppercase">Повтор</label>
                    <select id="ev-repeat" class="w-full h-12 font-bold text-xs">
                        <option value="none">Ні</option>
                        <option value="daily">Щодня</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="pt-8 space-y-3">
            <button onclick="window.saveEvent()" class="w-full py-4 btn-primary uppercase text-sm">Зберегти зміни</button>
            <div class="flex gap-2">
                <button onclick="window.deleteEvent()" id="btn-delete" class="flex-1 py-3 text-red-500 font-bold uppercase text-[10px] border border-red-500/20 rounded-xl">Видалити</button>
                <button onclick="window.closeModal()" class="flex-1 py-3 text-slate-500 font-bold uppercase text-[10px]">Закрити</button>
            </div>
        </div>
    </div>

    <main id="canvas-container" class="absolute inset-0 z-0"></main>

    <script>
        const IS_MOBILE = window.innerWidth < 768;
        const CONFIG = { 
            radius: IS_MOBILE ? 7 : 9, 
            heightPct: 220, 
            renderDays: 30, 
            baseDate: new Date().setHours(0,0,0,0)
        };
        const START_ANGLE = -Math.PI / 2;
        
        let events = JSON.parse(localStorage.getItem('iphilini_v63_data')) || [];
        let editingId = null;
        let minutePoints = null;
        let spiralLine = null;

        function toggleDrawer() { document.getElementById('main-sidebar').classList.toggle('drawer-open'); }

        const scene = new THREE.Scene();
        // ТУМАН: Робимо його дуже слабким, щоб спіраль не зникала при віддаленні
        scene.fog = new THREE.FogExp2(0x020617, 0.008); 

        const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 2000);
        camera.position.set(25, 35, 25);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        // Додаємо соковитості кольорам
        renderer.toneMapping = THREE.ReinhardToneMapping;
        renderer.toneMappingExposure = 1.5;
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;

        function createPointTexture() {
            const c = document.createElement('canvas'); c.width = 64; c.height = 64;
            const ctx = c.getContext('2d');
            const g = ctx.createRadialGradient(32,32,0,32,32,32);
            g.addColorStop(0, 'white');
            g.addColorStop(0.2, 'rgba(255,255,255,0.8)');
            g.addColorStop(0.5, 'rgba(255,255,255,0.2)');
            g.addColorStop(1, 'transparent');
            ctx.fillStyle = g; ctx.fillRect(0,0,64,64);
            return new THREE.CanvasTexture(c);
        }
        const pointTex = createPointTexture();

        const nowMarker = new THREE.Mesh(
            new THREE.SphereGeometry(0.5, 24, 24),
            new THREE.MeshBasicMaterial({ color: 0x00ffff, toneMapped: false })
        );
        scene.add(nowMarker);

        function getCoords(min) {
            const hrs = min / 60;
            const y = (hrs / 24) * (CONFIG.radius * (CONFIG.heightPct / 100));
            const a = (hrs / 24) * Math.PI * 2 + START_ANGLE;
            return { x: Math.cos(a)*CONFIG.radius, y: y, z: Math.sin(a)*CONFIG.radius };
        }

        function buildSpiral() {
            if(minutePoints) scene.remove(minutePoints);
            if(spiralLine) scene.remove(spiralLine);

            const totalMins = CONFIG.renderDays * 1440;
            const geo = new THREE.BufferGeometry();
            const pos = new Float32Array(totalMins * 3);
            const col = new Float32Array(totalMins * 3);
            const size = new Float32Array(totalMins);
            const linePts = [];

            for(let i=0; i<totalMins; i++) {
                const c = getCoords(i);
                pos[i*3] = c.x; pos[i*3+1] = c.y; pos[i*3+2] = c.z;
                if(i % 10 === 0) linePts.push(new THREE.Vector3(c.x, c.y, c.z));

                const isDay = i % 1440 === 0;
                const isHour = i % 60 === 0;

                if(isDay) {
                    col[i*3]=0.2; col[i*3+1]=0.6; col[i*3+2]=1.0; // Blue Day Start
                    size[i] = 2.5;
                } else if(isHour) {
                    col[i*3]=0.8; col[i*3+1]=0.8; col[i*3+2]=0.8; 
                    size[i] = 0.8;
                } else {
                    col[i*3]=0.1; col[i*3+1]=0.15; col[i*3+2]=0.25; 
                    size[i] = 0.3;
                }
            }

            geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
            geo.setAttribute('color', new THREE.BufferAttribute(col, 3));
            geo.setAttribute('size', new THREE.BufferAttribute(size, 1));

            minutePoints = new THREE.Points(geo, new THREE.PointsMaterial({
                vertexColors: true, map: pointTex, transparent: true, 
                opacity: 1, size: 1.2, sizeAttenuation: true, blending: THREE.AdditiveBlending
            }));
            scene.add(minutePoints);

            // Тонка лінія-провідник для контрасту
            const lineGeo = new THREE.BufferGeometry().setFromPoints(linePts);
            spiralLine = new THREE.Line(lineGeo, new THREE.LineBasicMaterial({ 
                color: 0x1e293b, transparent: true, opacity: 0.3 
            }));
            scene.add(spiralLine);

            applyEvents();
        }

        function applyEvents() {
            const colors = minutePoints.geometry.attributes.color;
            for(let i=0; i<colors.count; i++) {
                if(i%1440===0) colors.setXYZ(i,0,0.5,1);
                else if(i%60===0) colors.setXYZ(i,0.8,0.8,0.8);
                else colors.setXYZ(i,0.1,0.15,0.25);
            }

            events.forEach(ev => {
                const c = new THREE.Color(ev.color);
                const s = new Date(ev.start); const e = new Date(ev.end);
                const paint = (sMs, eMs) => {
                    let startIdx = Math.max(0, Math.floor((sMs - CONFIG.baseDate)/60000));
                    let endIdx = Math.min(colors.count, Math.floor((eMs - CONFIG.baseDate)/60000));
                    for(let k=startIdx; k<endIdx; k++) colors.setXYZ(k, c.r, c.g, c.b);
                };
                if(ev.repeat === 'daily') {
                    for(let d=0; d<CONFIG.renderDays; d++) paint(s.getTime() + d*864e5, e.getTime() + d*864e5);
                } else paint(s.getTime(), e.getTime());
            });
            colors.needsUpdate = true;
            updateList();
        }

        const raycaster = new THREE.Raycaster();
        raycaster.params.Points.threshold = 0.6;
        const mouse = new THREE.Vector2();

        function handleInteract(clientX, clientY, isClick) {
            mouse.x = (clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const hits = raycaster.intersectObject(minutePoints);
            
            if(hits.length > 0) {
                const idx = hits[0].index;
                const time = new Date(CONFIG.baseDate + idx * 60000);
                
                if(IS_MOBILE) {
                    const m = document.getElementById('tooltip-mobile'); m.style.display = 'block';
                    document.getElementById('tm-time').innerText = time.toLocaleTimeString('uk',{hour:'2-digit',minute:'2-digit'});
                } else {
                    const d = document.getElementById('tooltip-desktop'); d.style.display = 'block';
                    d.style.left = clientX + 15 + 'px'; d.style.top = clientY + 'px';
                    d.innerHTML = `<b>${time.toLocaleTimeString('uk',{hour:'2-digit',minute:'2-digit'})}</b>`;
                }
                if(isClick) window.openModal({start: time, end: new Date(time.getTime()+3600000)});
            }
        }

        window.addEventListener('mousemove', e => !IS_MOBILE && handleInteract(e.clientX, e.clientY, false));
        container.addEventListener('click', e => handleInteract(e.clientX, e.clientY, true));

        window.openModal = (ev) => {
            editingId = ev.id || null;
            const toISO = d => new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,16);
            document.getElementById('ev-summary').value = ev.summary || '';
            document.getElementById('ev-start').value = toISO(new Date(ev.start));
            document.getElementById('ev-end').value = toISO(new Date(ev.end));
            document.getElementById('ev-color').value = ev.color || '#3b82f6';
            document.getElementById('ev-repeat').value = ev.repeat || 'none';
            document.getElementById('btn-delete').style.display = editingId ? 'block' : 'none';
            const modal = document.getElementById('event-modal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.remove('translate-y-full', '-translate-x-full'), 10);
        };

        window.closeModal = () => {
            const m = document.getElementById('event-modal');
            if(IS_MOBILE) m.classList.add('translate-y-full'); else m.classList.add('-translate-x-full');
            setTimeout(() => m.style.display = 'none', 300);
        };

        window.saveEvent = () => {
            const data = {
                id: editingId || Date.now(),
                summary: document.getElementById('ev-summary').value || "План",
                start: new Date(document.getElementById('ev-start').value).getTime(),
                end: new Date(document.getElementById('ev-end').value).getTime(),
                repeat: document.getElementById('ev-repeat').value,
                color: document.getElementById('ev-color').value
            };
            if(editingId) events = events.map(e => e.id === editingId ? data : e); else events.push(data);
            localStorage.setItem('iphilini_v63_data', JSON.stringify(events));
            applyEvents(); closeModal();
        };

        window.deleteEvent = () => {
            events = events.filter(e => e.id !== editingId);
            localStorage.setItem('iphilini_v63_data', JSON.stringify(events));
            applyEvents(); closeModal();
        };

        function updateList() {
            const list = document.getElementById('sidebar-event-list');
            list.innerHTML = '';
            events.sort((a,b)=>a.start-b.start).forEach(ev => {
                const d = new Date(ev.start);
                const item = document.createElement('div');
                item.className = 'p-4 bg-slate-800/50 rounded-2xl border-l-4 mb-2 cursor-pointer';
                item.style.borderLeftColor = ev.color;
                item.innerHTML = `<div class="text-[10px] text-slate-500 font-bold uppercase mb-1">${d.toLocaleDateString('uk',{day:'numeric', month:'short'})}</div><div class="font-bold text-white">${ev.summary}</div><div class="text-xs text-blue-400 font-mono">${d.toLocaleTimeString('uk',{hour:'2-digit',minute:'2-digit'})}</div>`;
                item.onclick = () => window.openModal(ev);
                list.appendChild(item);
            });
        }

        function animate() {
            requestAnimationFrame(animate);
            const now = new Date();
            const p = getCoords((now - CONFIG.baseDate)/60000);
            nowMarker.position.set(p.x, p.y, p.z);
            nowMarker.scale.setScalar(1 + Math.sin(Date.now()*0.005)*0.2);
            
            const timeStr = now.toLocaleTimeString('uk');
            if(IS_MOBILE) document.getElementById('live-clock-mobile').innerText = timeStr;
            else document.getElementById('live-clock-desktop').innerText = timeStr;
            
            controls.update();
            renderer.render(scene, camera);
        }

        document.getElementById('in-height-pct').onchange = (e) => { CONFIG.heightPct = e.target.value; buildSpiral(); };
        document.getElementById('in-days').onchange = (e) => { CONFIG.renderDays = e.target.value; buildSpiral(); };

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        buildSpiral(); animate();
    </script>
</body>
</html>
