<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HELIX LAB: Chrono-Architecture</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Outfit:wght@400;700;900&display=swap');
        
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #f8fafc; font-family: 'Outfit', sans-serif; display: flex; flex-direction: row; color: #1e293b; }
        
        /* UI Layer Styles - LIGHT THEME */
        #ui-sidebar { 
            flex: 0 0 320px; 
            z-index: 20; 
            background: rgba(255, 255, 255, 0.85); 
            border-right: 1px solid #cbd5e1; 
            backdrop-filter: blur(20px); 
            display: flex; 
            flex-direction: column; 
            box-shadow: 10px 0 30px rgba(0,0,0,0.05);
        }
        
        #canvas-container { flex: 1; position: relative; background: #f1f5f9; touch-action: none; overflow: hidden; }
        
        .mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Custom Scrollbar - Light */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }
        
        /* Glass Inputs - Light */
        .glass-input { 
            background: rgba(0,0,0,0.03); 
            border: 1px solid #e2e8f0; 
            color: #1e293b; 
            transition: 0.3s; 
        }
        .glass-input:focus { border-color: #3b82f6; background: white; outline: none; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); }
        
        /* Buttons */
        .action-btn {
            background: #1e293b; 
            color: white;
            transition: all 0.2s;
        }
        .action-btn:hover { background: #334155; transform: translateY(-1px); }
        .secondary-btn {
            background: white;
            border: 1px solid #cbd5e1;
            color: #475569;
        }
        .secondary-btn:hover { background: #f8fafc; border-color: #94a3b8; color: #1e293b; }

        /* HUD Overlay */
        #hud-overlay { position: absolute; bottom: 20px; right: 20px; pointer-events: none; text-align: right; }
        .hud-text { font-size: 10px; color: #64748b; letter-spacing: 1px; text-transform: uppercase; font-weight: 700; }
        .hud-value { font-size: 24px; color: #0f172a; font-weight: 900; }
        
        details > summary { list-style: none; }
    </style>
</head>
<body>

    <div id="ui-sidebar" class="p-5 h-full">
        <div class="flex justify-between items-center border-b border-slate-200 pb-4 mb-4">
            <div>
                <h1 class="text-xl font-900 tracking-tighter text-slate-900">HELIX<span class="text-blue-600">.</span>LAB</h1>
                <p class="text-[9px] text-slate-500 mono tracking-widest">S3-S1 FRACTAL PROJECTION</p>
            </div>
            <div id="live-clock" class="text-sm font-bold mono text-blue-700 bg-blue-50 px-2 py-1 rounded border border-blue-100">00:00</div>
        </div>

        <div class="space-y-3 mb-6">
            <button onclick="openModal()" class="w-full py-3 rounded-xl text-xs font-bold uppercase tracking-widest shadow-lg shadow-slate-300/50 action-btn">
                + Нова Подія
            </button>
            
            <div class="flex gap-2">
                <button onclick="cameraToNow()" class="flex-1 py-2 rounded-lg text-[10px] font-bold uppercase tracking-wider secondary-btn">
                    Фокус: Зараз
                </button>
                <button onclick="toggleViewMode()" class="flex-1 py-2 rounded-lg text-[10px] font-bold uppercase tracking-wider secondary-btn">
                    Вигляд зверху
                </button>
            </div>
        </div>

        <details class="group mb-4" open>
            <summary class="cursor-pointer flex justify-between items-center text-[10px] font-bold text-slate-500 uppercase tracking-widest bg-slate-50 p-2 rounded hover:bg-slate-100 transition border border-slate-200">
                Параметри Простору <span class="group-open:rotate-180 transition-transform text-slate-400">▼</span>
            </summary>
            <div class="pt-4 space-y-4 px-1">
                <div>
                    <div class="flex justify-between text-[9px] text-slate-500 mb-1 font-bold">
                        <span>МАСШТАБ (Radius)</span>
                        <span id="val-radius">1.0</span>
                    </div>
                    <input id="cfg-radius" type="range" min="0.1" max="2" step="0.1" value="1" class="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-slate-800">
                </div>
                <div>
                    <div class="flex justify-between text-[9px] text-slate-500 mb-1 font-bold">
                        <span>КРОК ЧАСУ (Spacing)</span>
                        <span id="val-spacing">1.5</span>
                    </div>
                    <input id="cfg-spacing" type="range" min="0.5" max="3" step="0.1" value="1.5" class="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-slate-800">
                </div>
            </div>
        </details>

        <div class="flex-1 overflow-hidden flex flex-col">
            <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3 px-1">Список Подій</h3>
            <div id="event-list" class="flex-1 overflow-y-auto space-y-2 pr-1"></div>
        </div>
    </div>

    <div id="canvas-container">
        <div id="hud-overlay">
            <div class="hud-text">Поточна Точка</div>
            <div id="hud-date" class="hud-value">...</div>
            <div id="hud-details" class="text-xs text-slate-500 font-mono mt-1 font-bold">UTC / EARTH TIME SYNC</div>
        </div>
    </div>

    <div id="modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-6 bg-slate-900/20 backdrop-blur-sm">
        <div class="bg-white border border-slate-200 w-full max-w-[320px] p-6 rounded-[28px] shadow-2xl space-y-5">
            <h2 class="text-lg font-900 text-slate-800">Редактор</h2>
            <input id="ev-name" type="text" placeholder="Назва події..." class="glass-input w-full p-3 rounded-xl text-sm font-bold">
            <div class="grid grid-cols-1 gap-3">
                <div class="space-y-1">
                    <label class="text-[9px] text-slate-400 uppercase font-bold">Start</label>
                    <input id="ev-start" type="datetime-local" class="glass-input w-full p-2 rounded-lg text-xs mono">
                </div>
                <div class="space-y-1">
                    <label class="text-[9px] text-slate-400 uppercase font-bold">End</label>
                    <input id="ev-end" type="datetime-local" class="glass-input w-full p-2 rounded-lg text-xs mono">
                </div>
            </div>
            <div class="flex items-center gap-3 pt-2">
                <div class="relative w-10 h-10 shrink-0 overflow-hidden rounded-full border border-slate-200">
                    <input id="ev-color" type="color" value="#3b82f6" class="absolute inset-0 w-[150%] h-[150%] -top-[25%] -left-[25%] cursor-pointer p-0 border-0">
                </div>
                <button id="save-btn" class="flex-1 bg-slate-800 hover:bg-slate-700 text-white h-10 rounded-xl font-bold uppercase tracking-wider text-xs transition-colors">Зберегти</button>
                <button id="del-btn" class="hidden w-10 h-10 bg-red-50 hover:bg-red-100 text-red-600 border border-red-200 rounded-xl flex items-center justify-center transition-colors">✕</button>
            </div>
            <button onclick="closeModal()" class="w-full text-[10px] font-bold text-slate-400 uppercase tracking-widest hover:text-slate-600 transition-colors">Скасувати</button>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const CONFIG = {
            yearRadius: 30,
            monthRadius: 8,
            dayRadius: 2.5,
            tubeThick: 0.5,
            daysRender: 365, // Рік вперед
            daysBack: 30,    // Місяць назад
            spacingFactor: 1.5,
            scaleFactor: 1.0
        };

        const STORAGE_KEY = 'helix_lab_data';
        let events = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [
            { id: 1, name: "Архітектурний огляд", start: Date.now() - 3600000*2, end: Date.now() + 3600000, color: "#2563eb" },
            { id: 2, name: "Глибока фаза", start: Date.now() + 3600000*3, end: Date.now() + 3600000*6, color: "#475569" }
        ];
        let editingId = null;

        // --- THREE.JS ---
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene(); 
        scene.background = new THREE.Color(0xf1f5f9); // Light Slate Background
        // NO FOG (Infinite visibility)

        const camera = new THREE.PerspectiveCamera(45, container.clientWidth/container.clientHeight, 0.1, 2000);
        camera.position.set(0, 60, 100);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
        renderer.setSize(container.clientWidth, container.clientHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        container.appendChild(renderer.domElement);

        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;

        // Lighting (Studio Setup)
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);
        
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(50, 100, 50);
        dirLight.castShadow = true;
        dirLight.shadow.mapSize.width = 2048;
        dirLight.shadow.mapSize.height = 2048;
        scene.add(dirLight);

        // Groups
        const structureGroup = new THREE.Group();
        const eventsGroup = new THREE.Group();
        const cursorGroup = new THREE.Group();
        scene.add(structureGroup, eventsGroup, cursorGroup);

        // Materials (Dark/Contrast for Light Mode)
        // Використовуємо темні сірі кольори для ліній
        const lineMat = new THREE.LineBasicMaterial({ color: 0x334155, transparent: false, linewidth: 2 }); 
        const markerMat = new THREE.MeshStandardMaterial({ color: 0x1e293b, roughness: 0.4 });

        // --- MATH ENGINE ---
        const currentYearStart = new Date(new Date().getFullYear(), 0, 1).getTime();
        const msPerYear = 365.25 * 24 * 3600 * 1000;
        const msPerMonth = msPerYear / 12;
        const msPerDay = 24 * 3600 * 1000;

        function getFractalPosition(timestamp) {
            const tYear = (timestamp - currentYearStart) / msPerYear;
            const S3_R = CONFIG.yearRadius * CONFIG.scaleFactor;
            const S2_R = CONFIG.monthRadius * CONFIG.scaleFactor;
            const S1_R = CONFIG.dayRadius * CONFIG.scaleFactor;

            // S3 (Year)
            const thetaY = tYear * Math.PI * 2;
            const cy = tYear * 15 * CONFIG.spacingFactor; // Vertical drift
            const P3 = new THREE.Vector3(Math.cos(thetaY)*S3_R, cy, Math.sin(thetaY)*S3_R);

            // S2 (Month) - Rotates around S3
            const thetaM = ((timestamp - currentYearStart) / msPerMonth) * Math.PI * 2;
            const vRad = new THREE.Vector3(Math.cos(thetaY), 0, Math.sin(thetaY));
            const vUp = new THREE.Vector3(0, 1, 0);
            
            // Frame calculation
            const P2_offset = vRad.clone().multiplyScalar(Math.cos(thetaM)*S2_R)
                              .add(vUp.clone().multiplyScalar(Math.sin(thetaM)*S2_R));
            const P2 = P3.clone().add(P2_offset);

            // S1 (Day) - Rotates around S2
            const thetaD = ((timestamp - currentYearStart) / msPerDay) * Math.PI * 2;
            // Approximate Tangent of S2 loop
            const vTanM = vRad.clone().multiplyScalar(-Math.sin(thetaM))
                          .add(vUp.clone().multiplyScalar(Math.cos(thetaM))).normalize();
            const vN1 = new THREE.Vector3().crossVectors(vTanM, vRad).normalize(); 
            const vN2 = new THREE.Vector3().crossVectors(vTanM, vN1).normalize();
            
            const P1_offset = vN1.clone().multiplyScalar(Math.cos(thetaD)*S1_R)
                              .add(vN2.clone().multiplyScalar(Math.sin(thetaD)*S1_R));
            
            return P2.add(P1_offset);
        }

        // --- RENDER ---
        function buildStructure() {
            structureGroup.clear();
            const now = Date.now();
            const startT = now - (msPerDay * CONFIG.daysBack);
            const endT = now + (msPerDay * CONFIG.daysRender);
            
            // 1. Spine (Trajectory)
            const points = [];
            const step = msPerDay / 12; // 2 hours resolution for smooth curve
            for(let t = startT; t <= endT; t += step) {
                points.push(getFractalPosition(t));
            }
            const geometry = new THREE.BufferGeometry().setFromPoints(points);
            // Black distinct line
            const spine = new THREE.Line(geometry, lineMat);
            structureGroup.add(spine);

            // 2. Day Markers (Dots)
            const markerGeo = new THREE.SphereGeometry(0.25, 8, 8);
            const instancedMesh = new THREE.InstancedMesh(markerGeo, markerMat, Math.floor((endT-startT)/msPerDay) + 2);
            let idx = 0;
            const dummy = new THREE.Object3D();
            
            for(let t = startT; t <= endT; t += msPerDay) {
                const pos = getFractalPosition(t); 
                dummy.position.copy(pos);
                dummy.updateMatrix();
                instancedMesh.setMatrixAt(idx++, dummy.matrix);
            }
            instancedMesh.receiveShadow = true;
            instancedMesh.castShadow = true;
            structureGroup.add(instancedMesh);
        }

        function buildEvents() {
            eventsGroup.clear();
            events.forEach(ev => {
                const duration = ev.end - ev.start;
                if (duration <= 0) return;
                const segments = Math.max(10, Math.floor(duration / (1000 * 60 * 10)));
                const curvePoints = [];
                for(let i=0; i<=segments; i++) {
                    curvePoints.push(getFractalPosition(ev.start + (duration * (i/segments))));
                }
                const curve = new THREE.CatmullRomCurve3(curvePoints);
                const tubeGeo = new THREE.TubeGeometry(curve, segments, CONFIG.tubeThick, 8, false);
                const tubeMat = new THREE.MeshStandardMaterial({ 
                    color: ev.color, 
                    roughness: 0.3,
                    metalness: 0.1
                });
                const mesh = new THREE.Mesh(tubeGeo, tubeMat);
                mesh.userData = { id: ev.id };
                mesh.castShadow = true;
                mesh.receiveShadow = true;
                eventsGroup.add(mesh);
            });
        }

        function updateCursor() {
            cursorGroup.clear();
            const pos = getFractalPosition(Date.now());
            
            // Current Point (Orange/Red to contrast with Slate/Blue)
            const geo = new THREE.SphereGeometry(0.8, 16, 16);
            const mat = new THREE.MeshBasicMaterial({ color: 0xea580c }); // Orange-600
            const mesh = new THREE.Mesh(geo, mat);
            mesh.position.copy(pos);
            cursorGroup.add(mesh);
            
            // Ping Animation Ring
            const ringGeo = new THREE.RingGeometry(1.0, 1.2, 32);
            const ringMat = new THREE.MeshBasicMaterial({ color: 0xea580c, transparent: true, opacity: 0.5, side: THREE.DoubleSide });
            const ring = new THREE.Mesh(ringGeo, ringMat);
            ring.position.copy(pos);
            ring.lookAt(camera.position); // Billboarding
            ring.userData = { isRing: true };
            cursorGroup.add(ring);

            // Update UI
            document.getElementById('hud-date').innerText = new Date().toLocaleDateString('uk-UA', {day:'numeric', month:'long'});
        }

        // --- UI LOGIC ---
        function renderList() {
            const listEl = document.getElementById('event-list');
            listEl.innerHTML = events.sort((a,b) => a.start - b.start).map(ev => {
                const isPast = ev.end < Date.now();
                return `
                <div onclick="openModal(${ev.id})" class="p-3 mb-2 bg-white border border-slate-200 hover:border-blue-400 rounded-xl flex items-center justify-between cursor-pointer shadow-sm hover:shadow-md transition-all group ${isPast ? 'opacity-60 grayscale' : ''}">
                    <div class="flex items-center gap-3">
                        <div class="w-1 h-8 rounded-full" style="background:${ev.color}"></div>
                        <div>
                            <div class="text-[11px] font-bold text-slate-800 group-hover:text-blue-700">${ev.name}</div>
                            <div class="text-[9px] text-slate-500 mono">${new Date(ev.start).toLocaleTimeString([],{hour:'2-digit', minute:'2-digit'})}</div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        // Interaction
        const raycaster = new THREE.Raycaster();
        const pointer = new THREE.Vector2();
        container.addEventListener('pointerdown', (e) => {
            const rect = container.getBoundingClientRect();
            pointer.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
            pointer.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
            raycaster.setFromCamera(pointer, camera);
            const intersects = raycaster.intersectObjects(eventsGroup.children);
            if (intersects.length > 0) openModal(intersects[0].object.userData.id);
        });

        // Modal Helpers
        function openModal(id = null) {
            editingId = id;
            const ev = events.find(e => e.id === id) || { name: '', start: Date.now(), end: Date.now() + 3600000, color: '#2563eb' };
            document.getElementById('ev-name').value = ev.name;
            const toLocalISO = (ts) => new Date(ts - (new Date().getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
            document.getElementById('ev-start').value = toLocalISO(ev.start);
            document.getElementById('ev-end').value = toLocalISO(ev.end);
            document.getElementById('ev-color').value = ev.color;
            document.getElementById('del-btn').classList.toggle('hidden', !id);
            document.getElementById('modal').classList.remove('hidden');
        }
        function closeModal() { document.getElementById('modal').classList.add('hidden'); }
        
        document.getElementById('save-btn').onclick = () => {
            const data = {
                id: editingId || Date.now(),
                name: document.getElementById('ev-name').value,
                start: new Date(document.getElementById('ev-start').value).getTime(),
                end: new Date(document.getElementById('ev-end').value).getTime(),
                color: document.getElementById('ev-color').value
            };
            if(editingId) events = events.filter(e => e.id !== editingId);
            events.push(data);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(events));
            refreshAll();
            closeModal();
        };

        // Camera Control
        function cameraToNow() {
            const pos = getFractalPosition(Date.now());
            controls.target.copy(pos);
            camera.position.copy(pos).add(new THREE.Vector3(15, 15, 15));
        }
        function toggleViewMode() {
            camera.position.set(0, 300, 0);
            controls.target.set(0, 0, 0);
        }

        // Inputs
        document.getElementById('cfg-radius').oninput = (e) => { CONFIG.scaleFactor = parseFloat(e.target.value); document.getElementById('val-radius').innerText = CONFIG.scaleFactor; refreshAll(); };
        document.getElementById('cfg-spacing').oninput = (e) => { CONFIG.spacingFactor = parseFloat(e.target.value); document.getElementById('val-spacing').innerText = CONFIG.spacingFactor; refreshAll(); };

        function refreshAll() { buildStructure(); buildEvents(); updateCursor(); renderList(); }

        // Loop
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            
            // Ring Pulse
            const ring = cursorGroup.children.find(c => c.userData.isRing);
            if(ring) {
                ring.lookAt(camera.position);
                const s = 1 + Math.sin(Date.now() * 0.005) * 0.1;
                ring.scale.set(s, s, s);
            }
            
            renderer.render(scene, camera);
            
            // Live clock
            document.getElementById('live-clock').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        }

        window.addEventListener('resize', () => {
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        });

        // Init
        refreshAll();
        animate();
        setTimeout(cameraToNow, 100);

    </script>
</body>
</html>
