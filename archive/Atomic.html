<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>IPHILINI | Clarity v6.5</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #f8fafc; font-family: 'Inter', sans-serif; color: #1e293b; }
        .sidebar { background: white; border-right: 1px solid #e2e8f0; z-index: 40; box-shadow: 10px 0 30px rgba(0,0,0,0.03); }
        .mobile-drawer { background: white; border-top: 3px solid #3b82f6; transition: transform 0.4s ease; }
        .drawer-open { transform: translateY(0) !important; }
        input, select { background: #f1f5f9; color: #0f172a; border: 1px solid #cbd5e1; border-radius: 8px; padding: 10px; }
        .btn-add { background: #2563eb; color: white; font-weight: 800; border-radius: 12px; }
        #live-clock { color: #2563eb; font-weight: 900; }
    </style>
</head>
<body class="flex flex-col md:flex-row h-screen w-screen">

    <div class="fixed top-0 left-0 right-0 p-4 flex justify-between items-center z-50 pointer-events-none">
        <div class="pointer-events-auto bg-white/90 backdrop-blur p-3 px-5 rounded-2xl border border-slate-200 shadow-lg">
            <h1 class="text-[10px] font-black tracking-widest text-slate-400 uppercase">Iphilini Clarity</h1>
            <div id="live-clock" class="text-xl font-mono">--:--:--</div>
        </div>
        <button onclick="toggleDrawer()" class="pointer-events-auto bg-slate-900 p-4 rounded-2xl shadow-lg md:hidden">
            <svg width="24" height="24" fill="none" stroke="white" stroke-width="3" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h16"></path></svg>
        </button>
    </div>

    <aside id="main-sidebar" class="mobile-drawer fixed inset-x-0 bottom-0 h-[75vh] md:relative md:h-screen md:w-80 md:translate-y-0 transform translate-y-full sidebar flex flex-col rounded-t-[40px] md:rounded-none">
        <div class="w-full flex justify-center p-4 md:hidden" onclick="toggleDrawer()"><div class="w-12 h-1.5 bg-slate-200 rounded-full"></div></div>
        
        <div class="p-6 space-y-4">
            <button onclick="window.openModal({start: new Date(), end: new Date(Date.now()+3600000)})" class="w-full btn-add py-4 shadow-xl shadow-blue-200 uppercase text-xs tracking-widest">
                ＋ Створити подію
            </button>
            <div class="grid grid-cols-2 gap-3 text-[10px] font-bold text-slate-400 uppercase">
                <div>Витків: <input id="in-height-pct" type="number" value="250" class="w-full mt-1"></div>
                <div>Днів: <input id="in-days" type="number" value="30" class="w-full mt-1"></div>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto px-6">
            <h3 class="text-[10px] font-black text-slate-300 uppercase tracking-widest mb-4">Ваш розклад</h3>
            <div id="sidebar-event-list" class="space-y-3 pb-32 md:pb-10"></div>
        </div>
    </aside>

    <div id="event-modal" class="fixed inset-0 md:left-80 md:w-96 bg-white z-[2000] transform translate-y-full md:translate-y-0 md:-translate-x-full transition-transform duration-300 hidden flex-col p-8 border-r border-slate-200 shadow-2xl">
        <div class="flex justify-between items-center mb-8"><h2 class="text-xl font-black text-slate-900">Подія</h2><button onclick="window.closeModal()" class="text-slate-400 text-2xl">×</button></div>
        <div class="space-y-5 flex-1 overflow-y-auto">
            <input id="ev-summary" type="text" placeholder="Назва події..." class="w-full text-lg font-bold">
            <div class="grid gap-4">
                <div><label class="text-[10px] font-bold text-slate-400 uppercase">Початок</label><input id="ev-start" type="datetime-local" class="w-full font-mono mt-1"></div>
                <div><label class="text-[10px] font-bold text-slate-400 uppercase">Кінець</label><input id="ev-end" type="datetime-local" class="w-full font-mono mt-1"></div>
            </div>
            <div class="flex gap-4">
                <input id="ev-color" type="color" value="#3b82f6" class="flex-1 h-12">
                <select id="ev-repeat" class="flex-1 font-bold"><option value="none">Один раз</option><option value="daily">Щодня</option></select>
            </div>
        </div>
        <div class="pt-8 space-y-3">
            <button onclick="window.saveEvent()" class="w-full py-4 btn-add uppercase text-sm">Зберегти</button>
            <button onclick="window.deleteEvent()" id="btn-delete" class="w-full py-3 text-red-500 font-bold uppercase text-[10px]">Видалити</button>
        </div>
    </div>

    <main id="canvas-container" class="absolute inset-0 z-0 bg-slate-50"></main>

    <script>
        const IS_MOBILE = window.innerWidth < 768;
        const CONFIG = { radius: 10, heightPct: 250, renderDays: 30, baseDate: new Date().setHours(0,0,0,0) };
        const START_ANGLE = -Math.PI / 2;
        let events = JSON.parse(localStorage.getItem('iphilini_v65_data')) || [];
        let editingId = null, minutePoints = null;

        function toggleDrawer() { document.getElementById('main-sidebar').classList.toggle('drawer-open'); }

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xf8fafc); // Чіткий світлий фон

        const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 5000);
        camera.position.set(30, 45, 30);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;

        // МАРКЕР ЗАРАЗ (ЧЕРВОНИЙ)
        const nowMarker = new THREE.Mesh(
            new THREE.SphereGeometry(0.8, 24, 24),
            new THREE.MeshBasicMaterial({ color: 0xff0000 })
        );
        scene.add(nowMarker);

        function getCoords(min) {
            const hrs = min / 60;
            const y = (hrs / 24) * (CONFIG.radius * (CONFIG.heightPct / 100));
            const a = (hrs / 24) * Math.PI * 2 + START_ANGLE;
            return { x: Math.cos(a)*CONFIG.radius, y: y, z: Math.sin(a)*CONFIG.radius };
        }

        function buildSpiral() {
            if(minutePoints) scene.remove(minutePoints);
            const totalMins = CONFIG.renderDays * 1440;
            const geo = new THREE.BufferGeometry();
            const pos = new Float32Array(totalMins * 3), col = new Float32Array(totalMins * 3);

            for(let i=0; i<totalMins; i++) {
                const c = getCoords(i);
                pos[i*3]=c.x; pos[i*3+1]=c.y; pos[i*3+2]=c.z;
                
                const isDay = i % 1440 === 0, isHour = i % 60 === 0;
                if(isDay) { col[i*3]=0; col[i*3+1]=0; col[i*3+2]=0; } // Чорний початок дня
                else if(isHour) { col[i*3]=0.7; col[i*3+1]=0.7; col[i*3+2]=0.7; } // Сірі години
                else { col[i*3]=0.9; col[i*3+1]=0.9; col[i*3+2]=0.9; } // Дуже світлі хвилини
            }
            geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
            geo.setAttribute('color', new THREE.BufferAttribute(col, 3));

            minutePoints = new THREE.Points(geo, new THREE.PointsMaterial({
                vertexColors: true, size: 0.5, sizeAttenuation: true 
            }));
            scene.add(minutePoints);
            applyEvents();
            
            // Фокус на "зараз"
            const nowMin = (Date.now() - CONFIG.baseDate)/60000;
            const target = getCoords(nowMin);
            controls.target.set(target.x, target.y, target.z);
        }

        function applyEvents() {
            const colors = minutePoints.geometry.attributes.color;
            for(let i=0; i<colors.count; i++) {
                if(i%1440===0) colors.setXYZ(i,0,0,0);
                else if(i%60===0) colors.setXYZ(i,0.7,0.7,0.7);
                else colors.setXYZ(i,0.85,0.85,0.85);
            }
            events.forEach(ev => {
                const c = new THREE.Color(ev.color);
                const paint = (sMs, eMs) => {
                    let sIdx = Math.max(0, Math.floor((sMs - CONFIG.baseDate)/60000));
                    let eIdx = Math.min(colors.count, Math.floor((eMs - CONFIG.baseDate)/60000));
                    for(let k=sIdx; k<eIdx; k++) colors.setXYZ(k, c.r, c.g, c.b);
                };
                if(ev.repeat === 'daily') for(let d=0; d<CONFIG.renderDays; d++) paint(ev.start+d*864e5, ev.end+d*864e5);
                else paint(ev.start, ev.end);
            });
            colors.needsUpdate = true;
            updateList();
        }

        const raycaster = new THREE.Raycaster();
        raycaster.params.Points.threshold = 0.8;

        container.addEventListener('click', e => {
            const m = new THREE.Vector2((e.clientX/window.innerWidth)*2-1, -(e.clientY/window.innerHeight)*2+1);
            raycaster.setFromCamera(m, camera);
            const hits = raycaster.intersectObject(minutePoints);
            if(hits.length > 0) {
                const time = new Date(CONFIG.baseDate + hits[0].index * 60000);
                window.openModal({start: time, end: new Date(time.getTime()+3600000)});
            }
        });

        window.openModal = (ev) => {
            editingId = ev.id || null;
            const toISO = d => new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,16);
            document.getElementById('ev-summary').value = ev.summary || '';
            document.getElementById('ev-start').value = toISO(new Date(ev.start));
            document.getElementById('ev-end').value = toISO(new Date(ev.end));
            document.getElementById('ev-color').value = ev.color || '#3b82f6';
            document.getElementById('btn-delete').style.display = editingId ? 'block' : 'none';
            const m = document.getElementById('event-modal'); m.style.display = 'flex';
            setTimeout(() => m.classList.remove('translate-y-full', '-translate-x-full'), 10);
        };

        window.closeModal = () => {
            const m = document.getElementById('event-modal');
            if(IS_MOBILE) m.classList.add('translate-y-full'); else m.classList.add('-translate-x-full');
            setTimeout(() => m.style.display = 'none', 300);
        };

        window.saveEvent = () => {
            const data = { id: editingId || Date.now(), summary: document.getElementById('ev-summary').value || "План", start: new Date(document.getElementById('ev-start').value).getTime(), end: new Date(document.getElementById('ev-end').value).getTime(), repeat: document.getElementById('ev-repeat').value, color: document.getElementById('ev-color').value };
            if(editingId) events = events.map(e => e.id === editingId ? data : e); else events.push(data);
            localStorage.setItem('iphilini_v65_data', JSON.stringify(events));
            applyEvents(); closeModal();
        };

        window.deleteEvent = () => { events = events.filter(e => e.id !== editingId); localStorage.setItem('iphilini_v65_data', JSON.stringify(events)); applyEvents(); closeModal(); };

        function updateList() {
            const list = document.getElementById('sidebar-event-list'); list.innerHTML = '';
            events.sort((a,b)=>a.start-b.start).forEach(ev => {
                const item = document.createElement('div');
                item.className = 'p-4 bg-slate-50 border border-slate-100 rounded-2xl border-l-4 cursor-pointer hover:bg-white transition-all'; 
                item.style.borderLeftColor = ev.color;
                item.innerHTML = `<div class="text-[10px] text-slate-400 font-bold uppercase">${new Date(ev.start).toLocaleDateString('uk')}</div><div class="font-bold text-slate-800">${ev.summary}</div>`;
                item.onclick = () => window.openModal(ev);
                list.appendChild(item);
            });
        }

        function animate() {
            requestAnimationFrame(animate);
            const now = new Date();
            const p = getCoords((now - CONFIG.baseDate)/60000);
            nowMarker.position.set(p.x, p.y, p.z);
            nowMarker.scale.setScalar(1 + Math.sin(Date.now()*0.01)*0.2); // Пульсація
            
            document.getElementById('live-clock').innerText = now.toLocaleTimeString('uk');
            controls.update(); renderer.render(scene, camera);
        }

        document.getElementById('in-height-pct').onchange = (e) => { CONFIG.heightPct = e.target.value; buildSpiral(); };
        document.getElementById('in-days').onchange = (e) => { CONFIG.renderDays = e.target.value; buildSpiral(); };

        window.addEventListener('resize', () => { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });

        buildSpiral(); animate();
    </script>
</body>
</html>
