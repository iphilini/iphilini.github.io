<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>Krishna ¬∑ Voice Time Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      margin: 0;
      background: radial-gradient(circle at center, #0b1020, #05070f);
      color: #e0e6ff;
      font-family: system-ui, sans-serif;
      overflow: hidden;
    }

    #ui {
      position: absolute;
      top: 12px;
      left: 12px;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(10px);
      padding: 12px;
      border-radius: 8px;
      width: 280px;
      font-size: 14px;
    }

    button {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      background: #2a4bff;
      border: none;
      border-radius: 6px;
      color: white;
      font-size: 14px;
      cursor: pointer;
    }

    button.listening {
      background: #ff3366;
    }

    #log {
      margin-top: 10px;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
      opacity: 0.85;
    }

    canvas {
      display: block;
    }
  </style>
</head>

<body>

<div id="ui">
  <strong>Krishna ¬∑ –≥–æ–ª–æ—Å–æ–≤–∏–π –ø—Ä–æ—Ç–æ—Ç–∏–ø</strong>
  <div style="font-size:12px; opacity:0.8; margin-top:4px;">
    –ì–æ–≤–æ—Ä–∏ –≤—ñ–ª—å–Ω–æ. –Ø —Å–ª—É—Ö–∞—é —á–∞—Å.
  </div>

  <button id="micBtn">üéôÔ∏è –ü–æ—á–∞—Ç–∏ —Å–ª—É—Ö–∞—Ç–∏</button>

  <div id="log"></div>
</div>

<canvas id="canvas"></canvas>

<script>
/* =========================
   1. Canvas + —Å–ø—ñ—Ä–∞–ª—å
========================= */

const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

let fragments = [];

function drawSpiral() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  const cx = canvas.width / 2;
  const cy = canvas.height / 2;

  ctx.strokeStyle = '#3355ff';
  ctx.lineWidth = 2;
  ctx.beginPath();

  for (let i = 0; i < fragments.length; i++) {
    const a = i * 0.6;
    const r = 20 + i * 12;

    const x = cx + Math.cos(a) * r;
    const y = cy + Math.sin(a) * r;

    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  }

  ctx.stroke();

  // —Ç–æ—á–∫–∏-—Ñ—Ä–∞–≥–º–µ–Ω—Ç–∏
  fragments.forEach((f, i) => {
    const a = i * 0.6;
    const r = 20 + i * 12;

    ctx.fillStyle = 'rgba(255,255,100,0.8)';
    ctx.beginPath();
    ctx.arc(
      cx + Math.cos(a) * r,
      cy + Math.sin(a) * r,
      3 + f.confidence * 3,
      0,
      Math.PI * 2
    );
    ctx.fill();
  });
}

/* =========================
   2. –ì–æ–ª–æ—Å
========================= */

const SpeechRecognition =
  window.SpeechRecognition || window.webkitSpeechRecognition;

const recognition = new SpeechRecognition();
recognition.lang = 'uk-UA';
recognition.continuous = true;
recognition.interimResults = true;

let listening = false;
const micBtn = document.getElementById('micBtn');
const log = document.getElementById('log');

micBtn.onclick = () => {
  if (!listening) {
    recognition.start();
    listening = true;
    micBtn.textContent = '‚èπÔ∏è –ó—É–ø–∏–Ω–∏—Ç–∏';
    micBtn.classList.add('listening');
  } else {
    recognition.stop();
    listening = false;
    micBtn.textContent = 'üéôÔ∏è –ü–æ—á–∞—Ç–∏ —Å–ª—É—Ö–∞—Ç–∏';
    micBtn.classList.remove('listening');
  }
};

recognition.onresult = (event) => {
  const result = event.results[event.results.length - 1];
  if (!result.isFinal) return;

  const text = result[0].transcript.trim();
  const confidence = result[0].confidence ?? 0.5;

  const fragment = {
    time: Date.now(),
    text,
    confidence
  };

  fragments.push(fragment);

  const div = document.createElement('div');
  div.textContent = `‚Ä¢ ${text}`;
  log.prepend(div);

  speakReflection(text);
  drawSpiral();
};

/* =========================
   3. –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è (–∞–≥–µ–Ω—Ç)
========================= */

function speakReflection(text) {
  const utterance = new SpeechSynthesisUtterance();
  utterance.lang = 'uk-UA';

  utterance.text =
    text.length > 40
      ? '–Ø –∑–∞—Ñ—ñ–∫—Å—É–≤–∞–≤ –ø–æ–¥—ñ—é, —è–∫–∞ —â–µ —Ñ–æ—Ä–º—É—î—Ç—å—Å—è.'
      : '–Ø –ø–æ—á—É–≤ —Ñ—Ä–∞–≥–º–µ–Ω—Ç —á–∞—Å—É.';

  speechSynthesis.speak(utterance);
}

drawSpiral();
</script>

</body>
</html>
