<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Spiral Core v2 - Logic & Intervals</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #07090f; font-family: sans-serif; }
        .label { position: absolute; color: white; font-size: 10px; pointer-events: none; font-weight: bold; opacity: 0.6; }
    </style>
</head>
<body>
    <div id="ui" class="absolute top-8 left-8 z-10 text-white pointer-events-none">
        <h1 class="text-2xl font-black tracking-tighter uppercase mb-1">Logic V2: Temporal Intervals</h1>
        <div class="flex items-center gap-2">
            <div class="w-2 h-2 bg-cyan-400 rounded-full animate-pulse"></div>
            <p id="clock" class="text-cyan-400 font-mono text-sm uppercase tracking-widest"></p>
        </div>
    </div>

    <script>
        // --- 1. ПАРАМЕТРИ СИСТЕМИ ---
        const SPIRAL_CONFIG = {
            radius: 8,
            dayHeight: 12,      // Висота одного витка (доби)
            segments: 144,      // Деталізація (кожні 10 хв)
            visibleDays: 5,     // Скільки днів показувати
            baseDate: new Date().setHours(0,0,0,0) // "Нуль" на висоті Y=0
        };

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.body.appendChild(renderer.domElement);

        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        camera.position.set(18, 12, 18);
        controls.enableDamping = true;

        // Світло для об'єму
        scene.add(new THREE.AmbientLight(0xffffff, 0.5));
        const pLight = new THREE.PointLight(0x00ffff, 1, 100);
        pLight.position.set(10, 20, 10);
        scene.add(pLight);

        // --- 2. МАТЕМАТИЧНЕ ПЕРЕТВОРЕННЯ ---
        function dateToSpiralCoord(date) {
            const msSinceBase = date.getTime() - SPIRAL_CONFIG.baseDate;
            const hoursSinceBase = msSinceBase / (1000 * 60 * 60);
            
            const angle = (hoursSinceBase / 24) * Math.PI * 2;
            const y = (hoursSinceBase / 24) * SPIRAL_CONFIG.dayHeight;
            
            return {
                pos: new THREE.Vector3(
                    Math.cos(angle) * SPIRAL_CONFIG.radius,
                    y,
                    Math.sin(angle) * SPIRAL_CONFIG.radius
                ),
                angle: angle
            };
        }

        // --- 3. ВІЗУАЛІЗАЦІЯ ОСІ (GUIDE) ---
        function buildAxis() {
            const points = [];
            for (let h = -24; h < 24 * SPIRAL_CONFIG.visibleDays; h += 0.5) {
                const d = new Date(SPIRAL_CONFIG.baseDate + h * 3600000);
                points.push(dateToSpiralCoord(d).pos);
                
                // Кільця годин
                if (h % 1 === 0) {
                    const ringGeo = new THREE.TorusGeometry(SPIRAL_CONFIG.radius, 0.01, 8, 64);
                    const ringMat = new THREE.MeshBasicMaterial({ color: 0x1e293b, transparent: true, opacity: 0.3 });
                    const ring = new THREE.Mesh(ringGeo, ringMat);
                    ring.position.y = dateToSpiralCoord(d).pos.y;
                    ring.rotation.x = Math.PI/2;
                    scene.add(ring);
                }
            }
            const curve = new THREE.CatmullRomCurve3(points);
            const tube = new THREE.Mesh(
                new THREE.TubeGeometry(curve, 400, 0.04, 8, false),
                new THREE.MeshBasicMaterial({ color: 0x334155, transparent: true, opacity: 0.2 })
            );
            scene.add(tube);
        }
        buildAxis();

        // --- 4. МАРКЕР "ЗАРАЗ" ---
        const nowRing = new THREE.Mesh(
            new THREE.TorusGeometry(SPIRAL_CONFIG.radius, 0.15, 12, 100),
            new THREE.MeshStandardMaterial({ 
                color: 0x22d3ee, 
                emissive: 0x22d3ee, 
                emissiveIntensity: 2,
                transparent: true,
                opacity: 0.8
            })
        );
        nowRing.rotation.x = Math.PI/2;
        scene.add(nowRing);

        // --- 5. ЛОГІКА ІНТЕРВАЛЬНИХ ПОДІЙ ---
        function addIntervalEvent(startDate, endDate, color = 0x3b82f6, title = "") {
            const eventPoints = [];
            const durationHrs = (endDate - startDate) / 3600000;
            
            for (let i = 0; i <= durationHrs; i += 0.1) {
                const d = new Date(startDate.getTime() + i * 3600000);
                eventPoints.push(dateToSpiralCoord(d).pos);
            }
            
            const curve = new THREE.CatmullRomCurve3(eventPoints);
            const geo = new THREE.TubeGeometry(curve, Math.max(20, Math.floor(durationHrs * 10)), 0.3, 12, false);
            const mat = new THREE.MeshStandardMaterial({ 
                color: color, 
                metalness: 0.5, 
                roughness: 0.2,
                emissive: color,
                emissiveIntensity: 0.2
            });
            const mesh = new THREE.Mesh(geo, mat);
            scene.add(mesh);
        }

        // ДЕМО ПОДІЇ
        const today = new Date();
        
        // Подія 1: На 4 години
        const s1 = new Date(today.setHours(10, 0, 0));
        const e1 = new Date(today.setHours(14, 0, 0));
        addIntervalEvent(s1, e1, 0xf472b6); // Рожева

        // Подія 2: Вечірня
        const s2 = new Date(today.setHours(18, 0, 0));
        const e2 = new Date(today.setHours(21, 30, 0));
        addIntervalEvent(s2, e2, 0x60a5fa); // Синя

        // --- LOOP ---
        function animate() {
            requestAnimationFrame(animate);
            const now = new Date();
            const coord = dateToSpiralCoord(now);
            
            // Рух кільця "Зараз"
            nowRing.position.y = coord.pos.y;
            
            // Оновлення годинника в UI
            document.getElementById('clock').innerText = now.toLocaleTimeString();
            
            controls.update();
            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
