<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FLIP! v9.0 Google Sync</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&display=swap');
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #f8fafc; font-family: 'Outfit', sans-serif; display: flex; flex-direction: column; }
        
        #ui-layer { flex: 0 0 auto; z-index: 10; padding: 10px; }
        #canvas-container { flex: 1 1 auto; position: relative; background: white; border-top: 1px solid #e2e8f0; touch-action: none; }
        .interactive { pointer-events: auto; }
        .flip-card { background: white; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.06); }
        
        .day-btn { width: 32px; height: 32px; border-radius: 8px; font-size: 10px; font-weight: bold; border: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .day-btn.active { background: #2563eb; color: white; border-color: #2563eb; }
        
        .input-field { background: #f8fafc; border: 1px solid #e2e8f0; padding: 10px; border-radius: 12px; font-size: 13px; outline: none; width: 100%; transition: 0.2s; }
        .input-field:focus { border-color: #2563eb; background: #fff; }
        
        /* G-Cal Colors Palette */
        .color-opt { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
        .color-opt.selected { border-color: #0f172a; transform: scale(1.1); }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div class="flip-card p-4 w-full max-w-[360px] space-y-3 mx-auto">
            <div class="flex justify-between items-center border-b pb-3">
                <div class="flex items-baseline gap-2">
                    <h1 class="text-lg font-900 text-slate-900">FLIP<span class="text-blue-600">!</span></h1>
                    <span id="live-date" class="text-[10px] font-bold text-slate-400 uppercase tracking-wider"></span>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="focusToday()" class="text-xl text-slate-300 hover:text-blue-600 transition-colors" title="До сьогодні">◎</button>
                    <div id="live-clock" class="text-xs font-black bg-blue-50 text-blue-600 px-2.5 py-1 rounded-lg tabular-nums">00:00</div>
                </div>
            </div>

            <div class="flex items-center gap-2">
                <div class="relative group">
                    <button class="w-10 h-10 flex items-center justify-center bg-slate-50 border border-slate-100 rounded-full text-slate-500 hover:bg-white hover:shadow-md transition-all">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path><path d="M21 2v6h-6"></path><path d="M21 3l-9.1 9.1"></path></svg>
                    </button>
                    <div class="absolute top-full left-0 mt-2 w-48 bg-white rounded-xl shadow-xl border border-slate-100 hidden group-hover:block p-2 z-50">
                        <label class="flex items-center gap-2 px-3 py-2 hover:bg-slate-50 rounded-lg cursor-pointer text-xs font-bold text-slate-700">
                            <span>↓ Імпорт (.ics)</span>
                            <input type="file" class="hidden" accept=".ics,.json" onchange="handleFileImport(event)">
                        </label>
                        <button onclick="exportICS()" class="w-full text-left flex items-center gap-2 px-3 py-2 hover:bg-slate-50 rounded-lg text-xs font-bold text-slate-700">
                            <span>↑ Експорт (.ics)</span>
                        </button>
                        <div class="h-px bg-slate-100 my-1"></div>
                        <button onclick="exportJSON()" class="w-full text-left px-3 py-1 text-[10px] text-slate-400 hover:text-blue-600">Backup JSON</button>
                    </div>
                </div>
                
                <button onclick="openModal()" class="flex-1 py-3 bg-blue-600 text-white rounded-2xl text-xs font-black uppercase tracking-widest shadow-lg shadow-blue-200 active:scale-95 transition-all">
                    + Нова подія
                </button>
            </div>

            <details class="group">
                <summary class="list-none cursor-pointer flex justify-between items-center text-[9px] font-bold text-slate-400 uppercase tracking-widest pt-1">
                    Параметри <span class="group-open:rotate-180 transition-transform">▼</span>
                </summary>
                <div class="pt-3 space-y-3">
                    <div class="grid grid-cols-2 gap-2">
                        <div><p class="text-[7px] text-slate-400 ml-1">ВІД</p><input id="cfg-from" type="date" class="input-field py-1.5 text-xs"></div>
                        <div><p class="text-[7px] text-slate-400 ml-1">ДО</p><input id="cfg-to" type="date" class="input-field py-1.5 text-xs"></div>
                    </div>
                    <div><p class="text-[7px] text-slate-400 ml-1">ВИСОТА ВИТКА</p><input id="cfg-height" type="range" min="1" max="15" step="0.5" value="6" class="w-full h-1.5 bg-slate-100 rounded-lg appearance-none cursor-pointer accent-blue-600"></div>
                </div>
            </details>

            <details class="group border-t pt-3" open>
                <summary class="list-none cursor-pointer flex justify-between items-center text-[9px] font-bold text-slate-400 uppercase tracking-widest">
                    Розклад <span class="group-open:rotate-180 transition-transform">▼</span>
                </summary>
                <div id="event-list" class="mt-2 space-y-1.5 max-h-[160px] overflow-y-auto pr-1 custom-scroll"></div>
            </details>
        </div>
    </div>

    <div id="canvas-container"></div>

    <div id="modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-6 bg-slate-900/50 backdrop-blur-sm">
        <div class="bg-white w-full max-w-[320px] p-6 rounded-[28px] shadow-2xl space-y-4 animate-in fade-in zoom-in duration-200">
            <h2 class="text-lg font-900 text-slate-800">Подія</h2>
            <input id="ev-summary" type="text" placeholder="Назва (Summary)" class="input-field text-base font-bold">
            <input id="ev-desc" type="text" placeholder="Опис / Нотатки" class="input-field text-xs">
            
            <div class="grid grid-cols-1 gap-2">
                <div class="grid grid-cols-2 gap-2">
                    <input id="ev-start" type="datetime-local" class="input-field text-xs">
                    <input id="ev-end" type="datetime-local" class="input-field text-xs">
                </div>
            </div>

            <div class="flex justify-between gap-1 py-1">
                <div class="day-btn" data-day="MO">Пн</div><div class="day-btn" data-day="TU">Вт</div><div class="day-btn" data-day="WE">Ср</div>
                <div class="day-btn" data-day="TH">Чт</div><div class="day-btn" data-day="FR">Пт</div><div class="day-btn" data-day="SA">Сб</div><div class="day-btn" data-day="SU">Нд</div>
            </div>

            <div class="flex justify-between gap-1 py-2" id="color-palette">
                </div>
            <input type="hidden" id="ev-color" value="#039BE5">

            <div class="flex gap-2 pt-2">
                <button id="pre-save-btn" class="flex-1 bg-blue-600 text-white h-12 rounded-xl font-bold uppercase tracking-wider text-xs shadow-lg shadow-blue-200">Зберегти</button>
                <button id="del-btn" class="hidden w-12 h-12 bg-red-50 text-red-500 rounded-xl flex items-center justify-center font-bold hover:bg-red-100">✕</button>
            </div>
            <button onclick="closeModal()" class="w-full text-[10px] font-black text-slate-400 uppercase tracking-widest py-1">Скасувати</button>
        </div>
    </div>

    <script>
        const STORAGE_KEY = 'flip_v9_data';
        let events = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        let editingId = null;

        // --- GOOGLE CALENDAR COLORS ---
        const G_COLORS = {
            '#039BE5': 'Peacock', '#7986CB': 'Lavender', '#33B679': 'Sage', '#8E24AA': 'Grape',
            '#E67C73': 'Flamingo', '#F4511E': 'Tomato', '#F6BF26': 'Banana', '#0B8043': 'Basil'
        };
        
        // --- DATA & RRULE UTILS ---
        const WEEKDAYS = ['SU', 'MO', 'TU', 'WE', 'TH', 'FR', 'SA'];
        
        // Перетворюємо масив ['MO', 'WE'] в RRULE рядок
        function generateRRule(days) {
            if (!days || days.length === 0) return null;
            return `FREQ=WEEKLY;BYDAY=${days.join(',')}`;
        }
        
        // Парсимо RRULE рядок назад в масив днів
        function parseRRule(rrule) {
            if (!rrule) return [];
            const match = rrule.match(/BYDAY=([^;]+)/);
            return match ? match[1].split(',') : [];
        }

        // --- INIT DATES ---
        const dFrom = new Date(); dFrom.setHours(0,0,0,0);
        const dTo = new Date(); dTo.setDate(dFrom.getDate() + 14);
        document.getElementById('cfg-from').value = dFrom.toISOString().split('T')[0];
        document.getElementById('cfg-to').value = dTo.toISOString().split('T')[0];

        // --- THREE.JS ---
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene(); scene.background = new THREE.Color(0xffffff);
        const camera = new THREE.PerspectiveCamera(40, container.clientWidth/container.clientHeight, 0.1, 1000);
        camera.position.set(30, 40, 30);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        container.appendChild(renderer.domElement);
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;

        const mainGroup = new THREE.Group();
        const eventGroup = new THREE.Group();
        scene.add(mainGroup, eventGroup);

        const nowDisk = new THREE.Mesh(new THREE.CylinderGeometry(1.4, 1.4, 0.1, 32), new THREE.MeshBasicMaterial({ color: 0x2563eb }));
        scene.add(nowDisk);

        function getPos(timeMs) {
            const base = new Date(document.getElementById('cfg-from').value).getTime();
            const hrs = (timeMs - base) / 3600000;
            const hStep = parseFloat(document.getElementById('cfg-height').value);
            const angle = (hrs / 24) * Math.PI * 2;
            const y = (hrs / 24) * hStep; 
            return new THREE.Vector3(Math.cos(angle)*10, y, Math.sin(angle)*10);
        }

        function buildSpiral() {
            mainGroup.clear();
            const from = new Date(document.getElementById('cfg-from').value).getTime();
            const to = new Date(document.getElementById('cfg-to').value).getTime();
            if(to <= from) return;

            const pts = [];
            // Оптимізація точок: 1 точка на 30 хв
            for(let t = from; t <= to; t += 1800000) pts.push(getPos(t));
            
            const line = new THREE.Line(
                new THREE.BufferGeometry().setFromPoints(pts),
                new THREE.LineBasicMaterial({ color: 0x000000, opacity: 0.1, transparent: true })
            );
            mainGroup.add(line);
            
            // Маркери днів
            for(let t = from; t <= to; t += 3600000) {
                if(new Date(t).getHours() === 0) {
                    const dot = new THREE.Mesh(new THREE.SphereGeometry(0.15), new THREE.MeshBasicMaterial({color:0x000, opacity:0.3, transparent:true}));
                    dot.position.copy(getPos(t));
                    mainGroup.add(dot);
                }
            }
        }

        function update3D() {
            eventGroup.clear();
            const limitMin = new Date(document.getElementById('cfg-from').value).getTime();
            const limitMax = new Date(document.getElementById('cfg-to').value).getTime();

            events.forEach(ev => {
                // Генерація повторень для рендеру
                const instances = [];
                if (ev.rrule) {
                    const days = parseRRule(ev.rrule);
                    const startH = new Date(ev.start).getHours();
                    const startM = new Date(ev.start).getMinutes();
                    const duration = ev.end - ev.start;
                    
                    for(let t = limitMin; t <= limitMax; t += 86400000) {
                        const dayName = WEEKDAYS[new Date(t).getDay()];
                        if(days.includes(dayName)) {
                            const instanceStart = new Date(t);
                            instanceStart.setHours(startH, startM, 0, 0);
                            instances.push({ s: instanceStart.getTime(), e: instanceStart.getTime() + duration });
                        }
                    }
                } else {
                    instances.push({ s: ev.start, e: ev.end });
                }

                instances.forEach(inst => {
                    const start = Math.max(inst.s, limitMin);
                    const end = Math.min(inst.e, limitMax);
                    
                    if (start < end) {
                        const curvePts = [];
                        for(let i=0; i<=10; i++) curvePts.push(getPos(start + (end - start)*(i/10)));
                        const tube = new THREE.Mesh(
                            new THREE.TubeGeometry(new THREE.CatmullRomCurve3(curvePts), 12, 0.45, 8, false),
                            new THREE.MeshBasicMaterial({ color: ev.color })
                        );
                        tube.userData = { id: ev.id }; // ID батьківської події
                        eventGroup.add(tube);
                    }
                });
            });
            renderList();
        }

        // --- RAYCASTING (Fixed) ---
        const raycaster = new THREE.Raycaster();
        container.addEventListener('pointerdown', (e) => {
            const rect = container.getBoundingClientRect();
            const mouse = new THREE.Vector2(
                ((e.clientX - rect.left) / rect.width) * 2 - 1,
                -((e.clientY - rect.top) / rect.height) * 2 + 1
            );
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(eventGroup.children);
            if (intersects.length > 0) openModal(intersects[0].object.userData.id);
        });

        // --- ICS LOGIC ---
        function generateICS() {
            let ics = "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//FLIP//UA\n";
            events.forEach(ev => {
                const now = new Date().toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                const start = new Date(ev.start).toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                const end = new Date(ev.end).toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                
                ics += "BEGIN:VEVENT\n";
                ics += `UID:${ev.id}@flip\nDTSTAMP:${now}\n`;
                ics += `DTSTART:${start}\nDTEND:${end}\n`;
                ics += `SUMMARY:${ev.summary}\n`;
                if(ev.description) ics += `DESCRIPTION:${ev.description}\n`;
                if(ev.rrule) ics += `RRULE:${ev.rrule}\n`;
                ics += "END:VEVENT\n";
            });
            ics += "END:VCALENDAR";
            return ics;
        }

        window.exportICS = () => {
            const blob = new Blob([generateICS()], { type: 'text/calendar' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'flip_calendar.ics';
            link.click();
        };

        window.handleFileImport = (e) => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (ev) => {
                if(file.name.endsWith('.json')) {
                    events = JSON.parse(ev.target.result);
                } else {
                    // Простий парсер ICS (дуже базовий)
                    const lines = ev.target.result.split(/\r\n|\n|\r/);
                    let currentEvent = null;
                    lines.forEach(line => {
                        if(line.startsWith('BEGIN:VEVENT')) currentEvent = { id: Date.now() + Math.random(), color: '#039BE5' };
                        else if(line.startsWith('END:VEVENT')) { if(currentEvent) events.push(currentEvent); currentEvent = null; }
                        else if(currentEvent) {
                            if(line.startsWith('SUMMARY:')) currentEvent.summary = line.substring(8);
                            if(line.startsWith('RRULE:')) currentEvent.rrule = line.substring(6);
                            // Парсинг дати ICS складніший, тут спрощено для демо
                            // У реальному житті краще використовувати бібліотеку ical.js
                        }
                    });
                    alert('ICS Імпорт частковий (тільки структура). Рекомендую JSON для повної сумісності.');
                }
                save();
            };
            reader.readAsText(file);
        };

        window.exportJSON = () => {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([JSON.stringify(events)], {type:'application/json'}));
            a.download = 'flip_backup.json'; a.click();
        };

        // --- UI RENDER ---
        function renderList() {
            const list = document.getElementById('event-list');
            const limitMin = new Date(document.getElementById('cfg-from').value).getTime();
            
            // Сортуємо події (найближчі до початку діапазону)
            const sorted = events.map(e => ({
                ...e, 
                nextStart: e.rrule ? limitMin : e.start // Спрощено для списку
            })).sort((a,b) => a.nextStart - b.nextStart);

            list.innerHTML = sorted.map(ev => {
                const d = new Date(ev.start);
                return `
                <div onclick="openModal(${ev.id})" class="p-3 bg-slate-50 rounded-xl flex items-center justify-between cursor-pointer border border-transparent hover:border-blue-100 transition-all">
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="w-1.5 h-4 rounded-full" style="background:${ev.color}"></div>
                        <span class="text-[11px] font-bold text-slate-700 truncate">${ev.summary || 'Подія'}</span>
                    </div>
                    <div class="flex items-center gap-2">
                         ${ev.rrule ? '<span class="text-[9px] text-blue-500 font-bold">↻</span>' : ''}
                        <span class="text-[8px] font-black text-slate-400 uppercase">${d.toLocaleDateString('uk-UA', {day:'2-digit', month:'short'})}</span>
                    </div>
                </div>`;
            }).join('');
        }

        // --- MODAL & PALETTE ---
        const palette = document.getElementById('color-palette');
        Object.entries(G_COLORS).forEach(([hex, name]) => {
            const dot = document.createElement('div');
            dot.className = 'color-opt';
            dot.style.background = hex;
            dot.title = name;
            dot.onclick = () => {
                document.getElementById('ev-color').value = hex;
                document.querySelectorAll('.color-opt').forEach(d => d.classList.remove('selected'));
                dot.classList.add('selected');
            };
            palette.appendChild(dot);
        });

        function openModal(id = null) {
            editingId = id;
            const ev = events.find(e => e.id === id) || { summary: '', start: Date.now(), end: Date.now() + 3600000, color: '#039BE5' };
            
            document.getElementById('ev-summary').value = ev.summary;
            document.getElementById('ev-desc').value = ev.description || '';
            const toLocalISO = (ts) => new Date(ts - (new Date().getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
            document.getElementById('ev-start').value = toLocalISO(ev.start);
            document.getElementById('ev-end').value = toLocalISO(ev.end);
            document.getElementById('ev-color').value = ev.color;
            document.getElementById('del-btn').classList.toggle('hidden', !id);
            
            // Colors UI sync
            document.querySelectorAll('.color-opt').forEach(d => d.classList.remove('selected'));
            // Days UI sync
            const activeDays = parseRRule(ev.rrule);
            document.querySelectorAll('.day-btn').forEach(btn => btn.classList.toggle('active', activeDays.includes(btn.dataset.day)));

            document.getElementById('modal').classList.remove('hidden');
        }

        document.getElementById('pre-save-btn').onclick = () => {
            const days = Array.from(document.querySelectorAll('.day-btn.active')).map(b => b.dataset.day);
            const data = {
                id: editingId || Date.now(),
                summary: document.getElementById('ev-summary').value,
                description: document.getElementById('ev-desc').value,
                start: new Date(document.getElementById('ev-start').value).getTime(),
                end: new Date(document.getElementById('ev-end').value).getTime(),
                color: document.getElementById('ev-color').value,
                rrule: generateRRule(days)
            };
            events = events.filter(e => e.id !== editingId);
            events.push(data);
            save(); closeModal();
        };

        function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(events)); buildSpiral(); update3D(); }
        function closeModal() { document.getElementById('modal').classList.add('hidden'); }
        document.getElementById('del-btn').onclick = () => { events = events.filter(e => e.id !== editingId); save(); closeModal(); };
        document.querySelectorAll('.day-btn').forEach(btn => btn.onclick = () => btn.classList.toggle('active'));
        
        // Render triggers
        ['cfg-from', 'cfg-to', 'cfg-height'].forEach(id => document.getElementById(id).oninput = () => { buildSpiral(); update3D(); });
        function focusToday() { const p = getPos(Date.now()); controls.target.copy(p); camera.position.set(p.x+25, p.y+25, p.z+25); }

        function animate() {
            requestAnimationFrame(animate);
            const now = new Date();
            const pos = getPos(now.getTime());
            nowDisk.position.copy(pos);
            nowDisk.lookAt(getPos(now.getTime() + 100000));
            nowDisk.rotateX(Math.PI/2);
            document.getElementById('live-clock').innerText = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            document.getElementById('live-date').innerText = now.toLocaleDateString('uk-UA', {day:'numeric', month:'long'});
            controls.update(); renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => { camera.aspect = container.clientWidth / container.clientHeight; camera.updateProjectionMatrix(); renderer.setSize(container.clientWidth, container.clientHeight); });
        
        buildSpiral(); update3D(); animate(); focusToday();
    </script>
</body>
</html>
