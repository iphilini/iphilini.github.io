<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FLIP! v14.0 Convergence</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap');
        body { margin: 0; background: #f8fafc; color: #1e293b; font-family: 'Inter', sans-serif; overflow: hidden; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(0,0,0,0.05); border-radius: 24px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); }
        #canvas-container { background: radial-gradient(circle at center, #ffffff 0%, #e2e8f0 100%); }
        .event-item { transition: all 0.2s; border-left: 4px solid transparent; }
        .event-item:active { background: #f1f5f9; }
        .bottom-drawer { transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .bottom-drawer.active { transform: translateY(0); }
    </style>
</head>
<body>

    <div id="canvas-container" class="fixed inset-0"></div>

    <div class="relative z-10 pointer-events-none h-screen flex flex-col p-4">
        <header class="flex justify-between items-center pointer-events-auto">
            <div class="glass-card px-5 py-3 flex items-center gap-3">
                <span class="text-blue-600 font-bold text-xl">FLIP!</span>
                <span id="header-time" class="text-sm font-medium opacity-60"></span>
            </div>
            <div class="flex gap-2">
                <button onclick="core.importTrigger()" class="glass-card w-12 h-12 flex items-center justify-center text-xl">üì•</button>
                <button onclick="core.focusNow()" class="glass-card w-12 h-12 flex items-center justify-center text-xl">üéØ</button>
            </div>
        </header>

        <div class="mt-4 overflow-y-auto pointer-events-auto max-h-[40vh] space-y-2 pr-2" id="event-list">
            </div>

        <div class="mt-auto pb-6 flex justify-center">
            <button onclick="core.openEditor()" class="pointer-events-auto bg-blue-600 text-white px-8 py-4 rounded-full font-semibold shadow-lg shadow-blue-500/30 active:scale-95 transition">
                + –ù–û–í–ê –ü–û–î–Ü–Ø
            </button>
        </div>
    </div>

    <div id="editor" class="fixed inset-0 z-50 pointer-events-none flex items-end justify-center">
        <div class="bottom-drawer pointer-events-auto glass-card w-full max-w-lg p-6 rounded-b-none space-y-4">
            <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-2" onclick="core.closeEditor()"></div>
            <input id="ed-title" type="text" placeholder="–ù–∞–∑–≤–∞ –ø–æ–¥—ñ—ó" class="w-full text-lg font-semibold bg-transparent border-b-2 border-gray-100 py-2 outline-none focus:border-blue-500 transition">
            <div class="grid grid-cols-2 gap-4">
                <input id="ed-start" type="datetime-local" class="bg-gray-50 p-3 rounded-xl text-sm">
                <input id="ed-end" type="datetime-local" class="bg-gray-50 p-3 rounded-xl text-sm">
            </div>
            <div id="ed-colors" class="flex justify-between py-2"></div>
            <div class="flex gap-3">
                <button onclick="core.deleteEvent()" id="ed-del" class="hidden bg-red-50 text-red-500 flex-1 py-4 rounded-2xl font-bold">–í–ò–î–ê–õ–ò–¢–ò</button>
                <button onclick="core.saveEvent()" class="bg-blue-600 text-white flex-[2] py-4 rounded-2xl font-bold">–ó–ë–ï–†–ï–ì–¢–ò</button>
            </div>
        </div>
    </div>

    <input type="file" id="file-input" class="hidden" accept=".ics">

    <script>
        const core = {
            events: [],
            palette: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'],
            selectedColor: '#3b82f6',
            editingId: null,

            init() {
                this.setupThree();
                this.load();
                this.refresh();
                this.animate();
                this.initUI();
                setInterval(() => this.updateClock(), 1000);
            },

            setupThree() {
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 2000);
                this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.setPixelRatio(window.devicePixelRatio);
                document.getElementById('canvas-container').appendChild(this.renderer.domElement);
                
                this.controls = new THREE.OrbitControls(this.camera, this.renderer.domElement);
                this.controls.enableDamping = true;
                
                const light = new THREE.DirectionalLight(0xffffff, 1);
                light.position.set(10, 20, 10);
                this.scene.add(new THREE.AmbientLight(0xffffff, 0.8), light);
            },

            // –ú–∞—Ç–µ–º–∞—Ç–∏—á–Ω–∞ –º–æ–¥–µ–ª—å —Å–ø—ñ—Ä–∞–ª—ñ (–≤–∏–ø—Ä–∞–≤–ª–µ–Ω–∞)
            getPos(time) {
                const now = new Date();
                const dayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
                const diff = (time - dayStart) / 86400000; // –ß–∞—Å—Ç–∫–∞ –¥–Ω—è
                
                const radius = 15;
                const turnHeight = 12; // –í–∏—Å–æ—Ç–∞ –æ–¥–Ω–æ–≥–æ –≤–∏—Ç–∫–∞ (1 –¥–µ–Ω—å)
                const angle = diff * Math.PI * 2;
                
                return new THREE.Vector3(
                    Math.cos(angle) * radius,
                    diff * turnHeight,
                    Math.sin(angle) * radius
                );
            },

            refresh() {
                // –û—á–∏—â–µ–Ω–Ω—è
                while(this.scene.children.length > 2) this.scene.remove(this.scene.children[this.scene.children.length-1]);
                const list = document.getElementById('event-list');
                list.innerHTML = '';

                // –°–ø—ñ—Ä–∞–ª—å —Ñ–æ–Ω—É
                const pts = [];
                const start = Date.now() - 86400000 * 2;
                for(let i=0; i<24*10; i++) pts.push(this.getPos(start + i * 3600000));
                this.scene.add(new THREE.Line(new THREE.BufferGeometry().setFromPoints(pts), new THREE.LineBasicMaterial({color: 0xcbd5e1})));

                // –°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è –ø–æ–¥—ñ–π
                this.events.sort((a,b) => a.start - b.start).forEach(ev => {
                    this.drawEvent(ev);
                    this.addToList(ev);
                });

                // –ú–∞—Ä–∫–µ—Ä "–ó–∞—Ä–∞–∑"
                const nowMesh = new THREE.Mesh(new THREE.SphereGeometry(0.8), new THREE.MeshBasicMaterial({color: 0x3b82f6}));
                nowMesh.position.copy(this.getPos(Date.now()));
                this.scene.add(nowMesh);
            },

            drawEvent(ev) {
                const curvePts = [];
                for(let i=0; i<=20; i++) curvePts.push(this.getPos(ev.start + (ev.end - ev.start)*(i/20)));
                const tube = new THREE.TubeGeometry(new THREE.CatmullRomCurve3(curvePts), 32, 0.6, 8, false);
                const mesh = new THREE.Mesh(tube, new THREE.MeshPhongMaterial({color: ev.color, emissive: ev.color, emissiveIntensity: 0.2}));
                mesh.userData = { id: ev.id };
                this.scene.add(mesh);
            },

            addToList(ev) {
                const div = document.createElement('div');
                div.className = 'glass-card p-4 event-item pointer-events-auto flex justify-between items-center';
                div.style.borderLeftColor = ev.color;
                const timeStr = new Date(ev.start).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                div.innerHTML = `<div><div class="font-bold text-sm">${ev.title}</div><div class="text-[10px] opacity-50">${timeStr}</div></div>`;
                div.onclick = () => this.openEditor(ev.id);
                document.getElementById('event-list').appendChild(div);
            },

            // –†–æ–±–æ—Ç–∞ –∑ –¥–∞–Ω–∏–º–∏
            saveEvent() {
                const ev = {
                    id: this.editingId || Date.now(),
                    title: document.getElementById('ed-title').value || "–ü–æ–¥—ñ—è",
                    start: new Date(document.getElementById('ed-start').value).getTime(),
                    end: new Date(document.getElementById('ed-end').value).getTime(),
                    color: this.selectedColor
                };
                if(this.editingId) this.events = this.events.filter(e => e.id !== this.editingId);
                this.events.push(ev);
                this.save();
                this.refresh();
                this.closeEditor();
            },

            handleICS(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (f) => {
                    const blocks = f.target.result.split('BEGIN:VEVENT');
                    blocks.shift();
                    const imported = blocks.map(b => {
                        const title = (b.match(/SUMMARY:(.*)/) || [0,"–ü–æ–¥—ñ—è"])[1].trim();
                        const start = this.parseICSDate(b.match(/DTSTART[:;](.*)/));
                        const end = this.parseICSDate(b.match(/DTEND[:;](.*)/));
                        return { id: Math.random(), title, start, end, color: this.palette[Math.floor(Math.random()*6)] };
                    }).filter(ev => ev.start);
                    this.events = [...this.events, ...imported];
                    this.save(); this.refresh(); this.focusNow();
                };
                reader.readAsText(file);
            },

            parseICSDate(m) {
                if(!m) return null;
                const d = m[1].replace(/[^0-9T]/g, '');
                return new Date(`${d.slice(0,4)}-${d.slice(4,6)}-${d.slice(6,8)}T${d.slice(9,11)}:${d.slice(11,13)}:00`).getTime();
            },

            // UI –õ–æ–≥—ñ–∫–∞
            initUI() {
                const container = document.getElementById('ed-colors');
                this.palette.forEach(c => {
                    const btn = document.createElement('button');
                    btn.className = 'w-10 h-10 rounded-full border-4 border-transparent';
                    btn.style.background = c;
                    btn.onclick = () => {
                        this.selectedColor = c;
                        container.querySelectorAll('button').forEach(b => b.style.borderColor = 'transparent');
                        btn.style.borderColor = '#00000020';
                    };
                    container.appendChild(btn);
                });
            },

            openEditor(id = null) {
                this.editingId = id;
                const drawer = document.getElementById('editor');
                const delBtn = document.getElementById('ed-del');
                if(id) {
                    const ev = this.events.find(e => e.id === id);
                    document.getElementById('ed-title').value = ev.title;
                    document.getElementById('ed-start').value = new Date(ev.start - (new Date().getTimezoneOffset()*60000)).toISOString().slice(0,16);
                    document.getElementById('ed-end').value = new Date(ev.end - (new Date().getTimezoneOffset()*60000)).toISOString().slice(0,16);
                    this.selectedColor = ev.color;
                    delBtn.classList.remove('hidden');
                } else {
                    document.getElementById('ed-title').value = '';
                    delBtn.classList.add('hidden');
                }
                drawer.classList.remove('pointer-events-none');
                drawer.querySelector('.bottom-drawer').classList.add('active');
            },

            closeEditor() {
                const drawer = document.getElementById('editor');
                drawer.querySelector('.bottom-drawer').classList.remove('active');
                setTimeout(() => drawer.classList.add('pointer-events-none'), 400);
            },

            focusNow() {
                const target = this.getPos(Date.now());
                this.controls.target.lerp(target, 0.1);
                this.camera.position.set(target.x + 40, target.y + 20, target.z + 40);
            },

            updateClock() {
                document.getElementById('header-time').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            },
            
            importTrigger() { document.getElementById('file-input').click(); },
            save() { localStorage.setItem('flip_v14', JSON.stringify(this.events)); },
            load() { const d = localStorage.getItem('flip_v14'); if(d) this.events = JSON.parse(d); },
            deleteEvent() { this.events = this.events.filter(e => e.id !== this.editingId); this.save(); this.refresh(); this.closeEditor(); },
            animate() { requestAnimationFrame(() => this.animate()); this.controls.update(); this.renderer.render(this.scene, this.camera); }
        };

        core.init();
    </script>
</body>
</html>
