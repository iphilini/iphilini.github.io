<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FLIP! v17.0 Architect</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;500;800&display=swap');
        body { margin: 0; background: #ffffff; font-family: 'Plus Jakarta Sans', sans-serif; overflow: hidden; color: #1a1a1a; }
        .neo-glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(20px); border: 1px solid rgba(0,0,0,0.05); }
        .sidebar-event { border-radius: 16px; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; border: 1px solid transparent; }
        .sidebar-event:hover { border-color: #3b82f6; transform: translateX(5px); background: #f8fafc; }
        #canvas-container { background: radial-gradient(circle at 50% 50%, #fefefe 0%, #f1f5f9 100%); }
    </style>
</head>
<body>

    <div id="canvas-container" class="fixed inset-0"></div>

    <div class="relative z-10 pointer-events-none h-screen flex flex-row">
        
        <aside class="w-80 p-6 flex flex-col pointer-events-auto neo-glass shadow-2xl m-4 rounded-[32px]">
            <header class="mb-8">
                <div class="flex items-center justify-between">
                    <h1 class="text-2xl font-extrabold tracking-tighter text-blue-600">FLIP! <span class="text-gray-300 font-light">17</span></h1>
                    <div id="sync-status" class="w-3 h-3 bg-green-500 rounded-full shadow-[0_0_10px_#22c55e]"></div>
                </div>
                <p id="current-date" class="text-xs font-bold text-gray-400 mt-2 uppercase tracking-widest"></p>
            </header>

            <div class="flex-1 overflow-y-auto pr-2 space-y-4 no-scrollbar" id="google-list">
                <div class="opacity-30 text-center py-10 text-xs uppercase tracking-tighter">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó...</div>
            </div>

            <footer class="mt-6 pt-6 border-t border-gray-100">
                <button onclick="core.triggerSync()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold text-sm shadow-xl shadow-blue-200 active:scale-95 transition">
                    –°–ò–ù–•–†–û–ù–Ü–ó–£–í–ê–¢–ò GOOGLE
                </button>
            </footer>
        </aside>

        <main class="flex-1 flex flex-col justify-between p-8">
            <div class="flex justify-end gap-3 pointer-events-auto">
                <div class="neo-glass p-2 rounded-2xl flex gap-1">
                    <button onclick="core.setMode('day')" class="px-4 py-2 rounded-xl text-xs font-bold hover:bg-gray-100 transition">–î–ï–ù–¨</button>
                    <button onclick="core.setMode('week')" class="px-4 py-2 rounded-xl text-xs font-bold bg-blue-600 text-white shadow-lg">–¢–ò–ñ–î–ï–ù–¨</button>
                </div>
                <button onclick="core.focusNow()" class="neo-glass w-12 h-12 rounded-2xl flex items-center justify-center text-xl">üéØ</button>
            </div>

            <div class="pointer-events-auto flex justify-center pb-4">
                <div class="neo-glass px-10 py-5 rounded-[40px] flex items-center gap-8 shadow-2xl">
                    <div class="flex flex-col">
                        <span class="text-[9px] font-bold text-gray-400 uppercase">–©—ñ–ª—å–Ω—ñ—Å—Ç—å —á–∞—Å—É</span>
                        <input type="range" id="zoom" min="10" max="40" value="22" class="w-40 accent-blue-600" oninput="core.refresh()">
                    </div>
                    <div class="h-8 w-[1px] bg-gray-100"></div>
                    <button onclick="core.openAdd()" class="text-sm font-bold text-blue-600 hover:scale-105 transition">+ –ù–û–í–ê –Ü–ù–í–ê–†–Ü–ê–ù–¢–ê</button>
                </div>
            </div>
        </main>
    </div>

    <input type="file" id="ics-upload" class="hidden" accept=".ics">

    <script>
        const core = {
            events: [],
            mode: 'week',
            
            init() {
                this.setupThree();
                this.load();
                this.refresh();
                this.animate();
                this.updateDateUI();
                document.getElementById('ics-upload').addEventListener('change', (e) => this.handleICS(e));
            },

            setupThree() {
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 3000);
                this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                document.getElementById('canvas-container').appendChild(this.renderer.domElement);
                
                this.controls = new THREE.OrbitControls(this.camera, this.renderer.domElement);
                this.controls.enableDamping = true;
                this.camera.position.set(60, 40, 60);

                const sun = new THREE.DirectionalLight(0xffffff, 1);
                sun.position.set(10, 50, 10);
                this.scene.add(new THREE.AmbientLight(0xffffff, 0.7), sun);
            },

            // –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–Ω–æ-–∫–æ—Ä–µ–∫—Ç–Ω–∏–π —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ —Å–ø—ñ—Ä–∞–ª—ñ (–Ω–∞ –æ—Å–Ω–æ–≤—ñ PDF-–∞–Ω–∞–ª—ñ–∑—É)
            getPos(time) {
                const dayMs = 86400000;
                const now = new Date();
                const anchor = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
                const diff = (time - anchor) / dayMs;
                
                const radius = parseFloat(document.getElementById('zoom').value);
                const angle = diff * Math.PI * 2;
                return new THREE.Vector3(
                    Math.cos(angle) * radius,
                    diff * 18, // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∏–π –ø—Ä–æ–≥—Ä–µ—Å (–≤—ñ—Å—å Z —á–∞—Å—É)
                    Math.sin(angle) * radius
                );
            },

            refresh() {
                while(this.scene.children.length > 2) this.scene.remove(this.scene.children[this.scene.children.length-1]);
                const list = document.getElementById('google-list');
                list.innerHTML = '';

                // –†–µ–Ω–¥–µ—Ä —á–∞—Å–æ–≤–∏—Ö –æ—Ä—ñ—î–Ω—Ç–∏—Ä—ñ–≤ (–¥–Ω—ñ)
                const start = Date.now() - 86400000;
                for(let i=0; i<8; i++) {
                    const t = start + i * 86400000;
                    const p = this.getPos(t);
                    const ring = new THREE.Mesh(
                        new THREE.TorusGeometry(parseFloat(document.getElementById('zoom').value), 0.04, 8, 100),
                        new THREE.MeshBasicMaterial({ color: 0xe2e8f0 })
                    );
                    ring.position.y = p.y;
                    ring.rotation.x = Math.PI / 2;
                    this.scene.add(ring);
                }

                // –†–µ–Ω–¥–µ—Ä –ø–æ–¥—ñ–π —Ç–∞ —Å–ø–∏—Å–∫—É
                this.events.sort((a,b) => a.start - b.start).forEach(ev => {
                    this.drawEvent(ev);
                    this.addToList(ev);
                });

                // –ú–∞—Ä–∫–µ—Ä "–ó–∞—Ä–∞–∑"
                const nowPos = this.getPos(Date.now());
                const nowGeo = new THREE.SphereGeometry(0.8, 32, 32);
                const nowMat = new THREE.MeshBasicMaterial({ color: 0x3b82f6 });
                const marker = new THREE.Mesh(nowGeo, nowMat);
                marker.position.copy(nowPos);
                this.scene.add(marker);
            },

            drawEvent(ev) {
                const curvePts = [];
                for(let i=0; i<=20; i++) curvePts.push(this.getPos(ev.start + (ev.end - ev.start)*(i/20)));
                const tube = new THREE.TubeGeometry(new THREE.CatmullRomCurve3(curvePts), 32, 0.7, 8, false);
                const mesh = new THREE.Mesh(tube, new THREE.MeshPhongMaterial({ color: ev.color || '#3b82f6' }));
                this.scene.add(mesh);
            },

            addToList(ev) {
                const item = document.createElement('div');
                item.className = 'sidebar-event p-4 neo-glass';
                item.style.borderLeft = `4px solid ${ev.color || '#3b82f6'}`;
                const t = new Date(ev.start).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                item.innerHTML = `
                    <div class="text-[10px] font-bold text-blue-500 mb-1">${t}</div>
                    <div class="text-sm font-bold truncate">${ev.title}</div>
                    <div class="text-[9px] text-gray-400 mt-2 flex items-center gap-1">
                        <span class="w-2 h-2 rounded-full bg-green-400"></span> GOOGLE CALENDAR
                    </div>
                `;
                document.getElementById('google-list').appendChild(item);
            },

            handleICS(e) {
                const reader = new FileReader();
                reader.onload = (f) => {
                    const blocks = f.target.result.split('BEGIN:VEVENT');
                    blocks.shift();
                    const imported = blocks.map(b => {
                        const title = (b.match(/SUMMARY:(.*)/) || [0,"–ü–æ–¥—ñ—è"])[1].trim();
                        const start = this.parseICSDate(b.match(/DTSTART[:;](.*)/));
                        const end = this.parseICSDate(b.match(/DTEND[:;](.*)/));
                        return { title, start, end, color: this.getAutoColor(title) };
                    }).filter(ev => ev.start);
                    this.events = imported;
                    this.save(); this.refresh(); this.focusNow();
                };
                reader.readAsText(e.target.files[0]);
            },

            parseICSDate(m) {
                if(!m) return null;
                const d = m[1].replace(/[^0-9T]/g, '');
                return new Date(`${d.slice(0,4)}-${d.slice(4,6)}-${d.slice(6,8)}T${d.slice(9,11)}:${d.slice(11,13)}:00`).getTime();
            },

            getAutoColor(title) {
                const t = title.toLowerCase();
                if(t.includes('work')) return '#f97316';
                if(t.includes('meds')) return '#ef4444';
                if(t.includes('analytica')) return '#3b82f6';
                return '#64748b';
            },

            updateDateUI() {
                const n = new Date();
                document.getElementById('current-date').innerText = n.toLocaleDateString('uk-UA', { day:'numeric', month:'long', weekday:'long' });
            },

            focusNow() {
                const target = this.getPos(Date.now());
                this.controls.target.lerp(target, 0.1);
                this.camera.position.lerp(new THREE.Vector3(target.x+50, target.y+30, target.z+50), 0.1);
            },

            triggerSync() { document.getElementById('ics-upload').click(); },
            save() { localStorage.setItem('flip_v17', JSON.stringify(this.events)); },
            load() { const d = localStorage.getItem('flip_v17'); if(d) this.events = JSON.parse(d); },
            animate() { requestAnimationFrame(() => this.animate()); this.controls.update(); this.renderer.render(this.scene, this.camera); }
        };

        core.init();
    </script>
</body>
</html>
