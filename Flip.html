<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FLIP! v8.0 Data Master</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&display=swap');
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #fff; font-family: 'Outfit', sans-serif; }
        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        #ui-layer { position: relative; z-index: 10; width: 100%; height: 100%; pointer-events: none; }
        .interactive { pointer-events: auto; }
        .flip-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(15px); border-radius: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.08); }
        input, select { background: #f1f5f9; border-radius: 8px; padding: 6px; border: 1px solid #e2e8f0; font-size: 11px; font-weight: 600; width: 100%; }
        .day-btn { width: 30px; height: 30px; border-radius: 8px; font-size: 10px; font-weight: bold; border: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .day-btn.active { background: #2563eb; color: white; border-color: #2563eb; }
        .btn-data { padding: 6px 12px; border-radius: 8px; font-size: 9px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; transition: 0.2s; }
    </style>
</head>
<body>

    <div id="canvas-container"></div>

    <div id="ui-layer" class="p-3">
        <div class="flip-card p-4 w-full md:w-[340px] interactive space-y-3">
            <div class="flex justify-between items-center">
                <h1 class="text-xl font-900 text-slate-900">FLIP<span class="text-blue-600">!</span></h1>
                <div id="live-clock" class="text-xs font-bold bg-slate-100 px-3 py-1 rounded-full tabular-nums">00:00</div>
            </div>

            <div class="flex gap-2 pb-2 border-b border-slate-100">
                <button onclick="exportData()" class="btn-data bg-slate-100 text-slate-600 hover:bg-slate-200 flex-1">Експорт ↓</button>
                <label class="btn-data bg-slate-100 text-slate-600 hover:bg-slate-200 flex-1 text-center cursor-pointer">
                    Імпорт ↑ <input type="file" id="import-file" class="hidden" accept=".json" onchange="importData(event)">
                </label>
            </div>

            <button onclick="openModal()" class="w-full py-3 bg-blue-600 text-white rounded-xl text-[10px] font-bold uppercase tracking-widest">+ Нова подія</button>
            
            <div class="grid grid-cols-2 gap-2 pt-1">
                <div class="col-span-2">
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-[8px] font-bold text-slate-400 uppercase">Від:</label>
                            <input id="cfg-from" type="date">
                        </div>
                        <div>
                            <label class="text-[8px] font-bold text-slate-400 uppercase">До:</label>
                            <input id="cfg-to" type="date">
                        </div>
                    </div>
                </div>
                <div class="col-span-2">
                    <label class="text-[8px] font-bold text-slate-400 uppercase">Висота витка (Y)</label>
                    <input id="cfg-height" type="range" min="1" max="15" step="0.5" value="6" class="mt-1">
                </div>
            </div>

            <div class="pt-2 border-t">
                <button id="toggle-list" class="w-full flex justify-between items-center text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">
                    Мій Розклад <span id="list-arrow">▼</span>
                </button>
                <div id="event-list" class="hidden space-y-2 max-h-[180px] overflow-y-auto pr-1"></div>
            </div>
        </div>
    </div>

    <div id="modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm p-6 rounded-[24px] shadow-2xl interactive">
            <h2 class="text-lg font-bold mb-4">Подія</h2>
            <div class="space-y-4">
                <input id="ev-name" type="text" placeholder="Назва">
                <div class="grid grid-cols-2 gap-2">
                    <input id="ev-start" type="datetime-local">
                    <input id="ev-end" type="datetime-local">
                </div>
                <div class="flex justify-between" id="days-selector">
                    <div class="day-btn" data-day="1">Пн</div><div class="day-btn" data-day="2">Вт</div><div class="day-btn" data-day="3">Ср</div>
                    <div class="day-btn" data-day="4">Чт</div><div class="day-btn" data-day="5">Пт</div><div class="day-btn" data-day="6">Сб</div><div class="day-btn" data-day="0">Нд</div>
                </div>
                <div class="flex gap-2">
                    <input id="ev-color" type="color" value="#2563eb" class="h-10 w-14 border-none p-0 cursor-pointer overflow-hidden rounded-lg">
                    <button id="pre-save-btn" class="flex-1 bg-blue-600 text-white rounded-lg text-[10px] font-bold uppercase">Зберегти</button>
                    <button id="del-btn" class="hidden bg-red-50 text-red-500 px-3 rounded-lg font-bold">✕</button>
                </div>
                <button onclick="closeModal()" class="w-full text-slate-400 font-bold text-[9px] uppercase pt-1 text-center">Закрити</button>
            </div>
        </div>
    </div>

    <div id="series-modal" class="fixed inset-0 z-[110] hidden flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-md">
        <div class="bg-white w-full max-w-xs p-6 rounded-[24px] shadow-2xl interactive text-center space-y-4">
            <h3 class="font-bold">Це частина серії</h3>
            <button onclick="saveSeries('only')" class="w-full p-3 rounded-xl border font-bold text-xs hover:bg-slate-50">Тільки ця подія</button>
            <button onclick="saveSeries('all')" class="w-full p-3 rounded-xl border font-bold text-xs bg-blue-600 text-white">Уся серія</button>
        </div>
    </div>

    <script>
        // Спроба завантажити дані з будь-якої попередньої версії FLIP
        const STORAGE_KEY = 'flip_calendar_data';
        let events = JSON.parse(localStorage.getItem(STORAGE_KEY)) || JSON.parse(localStorage.getItem('flip_v79')) || [];
        let editingId = null;
        let tempSaveData = null;

        // Налаштування початкових дат
        const dFrom = new Date();
        const dTo = new Date(); dTo.setDate(dFrom.getDate() + 14);
        document.getElementById('cfg-from').value = dFrom.toISOString().split('T')[0];
        document.getElementById('cfg-to').value = dTo.toISOString().split('T')[0];

        // --- THREE.JS СЦЕНА ---
        const scene = new THREE.Scene(); scene.background = new THREE.Color(0xffffff);
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.set(40, 40, 40);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.getElementById('canvas-container').appendChild(renderer.domElement);
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;

        const mainGroup = new THREE.Group();
        const eventGroup = new THREE.Group();
        scene.add(mainGroup, eventGroup);

        const nowDisk = new THREE.Mesh(new THREE.CylinderGeometry(1.6, 1.6, 0.2, 32), new THREE.MeshBasicMaterial({ color: 0x2563eb }));
        scene.add(nowDisk);

        function getPos(timeMs) {
            const base = new Date(document.getElementById('cfg-from').value).getTime();
            const hrs = (timeMs - base) / 3600000;
            const hStep = parseFloat(document.getElementById('cfg-height').value);
            const angle = (hrs / 24) * Math.PI * 2;
            const y = (hrs / 24) * hStep; 
            return new THREE.Vector3(Math.cos(angle)*12, y, Math.sin(angle)*12);
        }

        function buildSpiral() {
            mainGroup.clear();
            const from = new Date(document.getElementById('cfg-from').value).getTime();
            const to = new Date(document.getElementById('cfg-to').value).getTime();
            const hrsTotal = (to - from) / 3600000;

            const pts = [];
            for(let h=0; h <= hrsTotal; h += 0.1) pts.push(getPos(from + h*3600000));
            
            mainGroup.add(new THREE.Line(
                new THREE.BufferGeometry().setFromPoints(pts), 
                new THREE.LineBasicMaterial({color:0x000, opacity:0.1, transparent:true})
            ));
            
            for(let h=0; h <= hrsTotal; h++) {
                if(h % 24 === 0) {
                    const dot = new THREE.Mesh(new THREE.SphereGeometry(0.15), new THREE.MeshBasicMaterial({color:0x000, opacity:0.3, transparent:true}));
                    dot.position.copy(getPos(from + h*3600000));
                    mainGroup.add(dot);
                }
            }
        }

        function update3D() {
            eventGroup.clear();
            const from = new Date(document.getElementById('cfg-from').value).getTime();
            const to = new Date(document.getElementById('cfg-to').value).getTime();

            events.forEach(ev => {
                if(ev.start > to || ev.end < from) return;
                const curvePts = [];
                const steps = 16;
                for(let i=0; i<=steps; i++) curvePts.push(getPos(ev.start + (ev.end - ev.start)*(i/steps)));
                const tube = new THREE.Mesh(
                    new THREE.TubeGeometry(new THREE.CatmullRomCurve3(curvePts), 24, 0.6, 8),
                    new THREE.MeshBasicMaterial({ color: ev.color })
                );
                tube.userData = { id: ev.id };
                eventGroup.add(tube);
            });
            renderList();
        }

        // --- ЕКСПОРТ ТА ІМПОРТ ---
        window.exportData = function() {
            const dataStr = JSON.stringify(events, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `flip_backup_${new Date().toISOString().slice(0,10)}.json`;
            link.click();
        };

        window.importData = function(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    if(Array.isArray(imported)) {
                        events = imported;
                        saveAndRefresh();
                        alert('Дані успішно імпортовано!');
                    }
                } catch(err) { alert('Помилка у файлі!'); }
            };
            reader.readAsText(file);
        };

        function saveAndRefresh() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(events));
            buildSpiral();
            update3D();
        }

        // --- ЛОГІКА ПОДІЙ ---
        function createSeries(data) {
            const from = new Date(document.getElementById('cfg-from').value).getTime();
            const to = new Date(document.getElementById('cfg-to').value).getTime();
            const groupId = data.groupId || Date.now();
            const duration = data.end - data.start;
            const res = [];
            for(let t = from; t <= to; t += 86400000) {
                if(data.repeat.includes(new Date(t).getDay())) {
                    const s = new Date(t).setHours(new Date(data.start).getHours(), new Date(data.start).getMinutes());
                    res.push({ id: Math.random(), groupId, name: data.name, start: s, end: s + duration, color: data.color, repeat: data.repeat });
                }
            }
            return res;
        }

        document.getElementById('pre-save-btn').onclick = () => {
            const repeat = Array.from(document.querySelectorAll('.day-btn.active')).map(b => parseInt(b.dataset.day));
            const data = {
                name: document.getElementById('ev-name').value || 'План',
                start: new Date(document.getElementById('ev-start').value).getTime(),
                end: new Date(document.getElementById('ev-end').value).getTime(),
                color: document.getElementById('ev-color').value,
                repeat
            };
            const existing = events.find(e => e.id === editingId);
            if(existing && existing.groupId && repeat.length > 0) {
                tempSaveData = { ...data, groupId: existing.groupId };
                document.getElementById('series-modal').classList.remove('hidden');
            } else {
                if(repeat.length > 0) {
                    events = events.filter(e => e.id !== editingId);
                    events.push(...createSeries(data));
                } else {
                    const single = { ...data, id: editingId || Date.now(), groupId: null };
                    if(editingId) events = events.map(e => e.id === editingId ? single : e);
                    else events.push(single);
                }
                saveAndRefresh(); closeModal();
            }
        };

        function saveSeries(type) {
            if(type === 'all') {
                events = events.filter(e => e.groupId !== tempSaveData.groupId);
                events.push(...createSeries(tempSaveData));
            } else {
                const single = { ...tempSaveData, id: Date.now(), groupId: null, repeat: [] };
                events = events.map(e => e.id === editingId ? single : e);
            }
            saveAndRefresh();
            closeModal();
            document.getElementById('series-modal').classList.add('hidden');
        }

        function renderList() {
            const unique = []; const seen = new Set();
            [...events].sort((a,b) => a.start - b.start).forEach(e => {
                const key = e.groupId || e.id;
                if(!seen.has(key)) { unique.push(e); seen.add(key); }
            });

            document.getElementById('event-list').innerHTML = unique.map(ev => {
                const s = new Date(ev.start).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                const e = new Date(ev.end).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                return `
                <div onclick="openModal(${ev.id})" class="p-3 bg-slate-50 border border-transparent hover:border-blue-600 rounded-xl flex flex-col gap-1 cursor-pointer interactive">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <div class="w-2 h-2 rounded-full" style="background:${ev.color}"></div>
                            <span class="text-[11px] font-900 text-slate-800 truncate">${ev.name}</span>
                        </div>
                        ${ev.repeat.length > 0 ? '<span class="text-blue-600 text-[10px]">↻</span>' : ''}
                    </div>
                    <div class="flex justify-between text-[9px] text-slate-400 font-bold tabular-nums">
                        <span>${s} — ${e}</span>
                        <span>${ev.repeat.length > 0 ? 'СЕРІЯ' : ''}</span>
                    </div>
                </div>
            `}).join('');
        }

        function openModal(id = null) {
            editingId = id;
            const ev = events.find(e => e.id === id) || { name:'', start:Date.now(), end:Date.now()+3600000, color:'#2563eb', repeat:[] };
            document.getElementById('ev-name').value = ev.name;
            document.getElementById('ev-start').value = new Date(ev.start).toISOString().slice(0,16);
            document.getElementById('ev-end').value = new Date(ev.end).toISOString().slice(0,16);
            document.getElementById('ev-color').value = ev.color;
            document.getElementById('del-btn').classList.toggle('hidden', !id);
            document.querySelectorAll('.day-btn').forEach(btn => btn.classList.toggle('active', ev.repeat.includes(parseInt(btn.dataset.day))));
            document.getElementById('modal').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('modal').classList.add('hidden'); }
        document.getElementById('del-btn').onclick = () => { events = events.filter(e => e.id !== editingId); saveAndRefresh(); closeModal(); };
        document.querySelectorAll('.day-btn').forEach(btn => btn.onclick = () => btn.classList.toggle('active'));
        document.getElementById('toggle-list').onclick = () => {
            const list = document.getElementById('event-list');
            list.classList.toggle('hidden');
            document.getElementById('list-arrow').innerText = list.classList.contains('hidden') ? '▼' : '▲';
        };

        // Raycasting
        const raycaster = new THREE.Raycaster();
        function handleInteract(x, y) {
            const m = new THREE.Vector2((x/window.innerWidth)*2-1, -(y/window.innerHeight)*2+1);
            raycaster.setFromCamera(m, camera);
            const hits = raycaster.intersectObjects(eventGroup.children);
            if(hits.length > 0) openModal(hits[0].object.userData.id);
        }
        window.addEventListener('mousedown', (e) => e.target.tagName === 'CANVAS' && handleInteract(e.clientX, e.clientY));
        window.addEventListener('touchstart', (e) => e.target.tagName === 'CANVAS' && handleInteract(e.touches[0].clientX, e.touches[0].clientY));

        function animate() {
            requestAnimationFrame(animate);
            const nowMs = Date.now();
            const pos = getPos(nowMs);
            nowDisk.position.copy(pos);
            nowDisk.lookAt(getPos(nowMs + 100000));
            nowDisk.rotateX(Math.PI/2);
            document.getElementById('live-clock').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            controls.update();
            renderer.render(scene, camera);
        }

        ['cfg-from', 'cfg-to', 'cfg-height'].forEach(id => document.getElementById(id).onchange = () => { buildSpiral(); update3D(); });

        buildSpiral(); update3D(); animate();
        controls.target.copy(getPos(Date.now()));
    </script>
</body>
</html>
