<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FLIP! v16.0 Omni-Sync</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        body { margin: 0; background: #f0f2f5; font-family: 'JetBrains+Mono', monospace; overflow: hidden; }
        .glass-ui { background: rgba(255, 255, 255, 0.9); backdrop-filter: saturate(180%) blur(15px); border: 1px solid rgba(255,255,255,0.5); }
        .event-tag { font-size: 9px; padding: 2px 6px; border-radius: 4px; color: white; font-weight: bold; }
        #canvas-container { position: absolute; inset: 0; z-index: 1; }
    </style>
</head>
<body>

    <div id="canvas-container"></div>

    <div class="relative z-10 pointer-events-none h-screen flex flex-col p-4 justify-between">
        
        <header class="flex justify-between items-start pointer-events-auto">
            <div class="glass-ui p-4 rounded-3xl shadow-2xl">
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                    <h1 class="font-black text-xl tracking-tighter">FLIP! <span class="opacity-30">v16</span></h1>
                </div>
                <div id="real-time" class="text-2xl font-bold mt-1 text-blue-600">00:00:00</div>
            </div>
            <div class="flex flex-col gap-2">
                <button onclick="core.importTrigger()" class="glass-ui w-14 h-14 rounded-2xl flex items-center justify-center text-2xl shadow-xl">üìÖ</button>
                <button onclick="core.focusNow()" class="glass-ui w-14 h-14 rounded-2xl flex items-center justify-center text-2xl shadow-xl">üéØ</button>
            </div>
        </header>

        <div class="pointer-events-auto overflow-x-auto flex gap-3 pb-4 no-scrollbar" id="google-feed">
            </div>

        <footer class="pointer-events-auto flex flex-col gap-3">
            <div class="glass-ui p-6 rounded-[40px] shadow-2xl space-y-4">
                <div class="flex justify-between text-[10px] font-bold text-gray-400 uppercase tracking-widest">
                    <span>–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è: –ê–∫—Ç–∏–≤–Ω–∞</span>
                    <span id="event-count">0 –ø–æ–¥—ñ–π</span>
                </div>
                <div class="flex gap-4 items-center">
                    <input type="range" id="spiral-radius" min="10" max="40" value="20" class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600" oninput="core.refresh()">
                    <button onclick="core.clearAll()" class="text-[10px] text-red-500 font-bold border border-red-100 px-3 py-1 rounded-full bg-red-50">RESET</button>
                </div>
                <button onclick="core.focusNow()" class="w-full bg-black text-white py-5 rounded-3xl font-bold text-sm tracking-widest active:scale-95 transition-transform shadow-lg shadow-black/20">
                    –ü–ï–†–ï–ô–¢–ò –î–û –ü–û–¢–û–ß–ù–û–ì–û –ß–ê–°–£
                </button>
            </div>
        </footer>
    </div>

    <input type="file" id="ics-input" class="hidden" accept=".ics">

    <script>
        const core = {
            events: [],
            // –ö–æ–ª—å–æ—Ä–æ–≤–∞ –ø–∞–ª—ñ—Ç—Ä–∞ –Ω–∞ –æ—Å–Ω–æ–≤—ñ –≤–∞—à–∏—Ö –¥–∞–Ω–∏—Ö (Work, Meds, Analytica)
            catColors: {
                'work': '#e67e22',
                'analytica': '#3498db',
                'meds': '#e74c3c',
                'sleep': '#2c3e50',
                'default': '#95a5a6'
            },

            init() {
                this.setupScene();
                this.load();
                this.refresh();
                this.animate();
                
                document.getElementById('ics-input').addEventListener('change', (e) => this.handleICS(e));
                setInterval(() => {
                    document.getElementById('real-time').innerText = new Date().toLocaleTimeString('uk-UA');
                }, 1000);
            },

            setupScene() {
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 3000);
                this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.setPixelRatio(window.devicePixelRatio);
                document.getElementById('canvas-container').appendChild(this.renderer.domElement);
                
                this.controls = new THREE.OrbitControls(this.camera, this.renderer.domElement);
                this.controls.enableDamping = true;
                this.camera.position.set(50, 50, 50);

                const ambient = new THREE.AmbientLight(0xffffff, 0.8);
                this.scene.add(ambient);
            },

            getSpiralPos(time) {
                const now = new Date();
                const dayZero = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
                const dayProgress = (time - dayZero) / 86400000;
                
                const radius = parseFloat(document.getElementById('spiral-radius').value);
                const angle = dayProgress * Math.PI * 2;
                return new THREE.Vector3(
                    Math.cos(angle) * radius,
                    dayProgress * 15, // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∏–π –∫—Ä–æ–∫
                    Math.sin(angle) * radius
                );
            },

            refresh() {
                while(this.scene.children.length > 1) this.scene.remove(this.scene.children[1]);
                const feed = document.getElementById('google-feed');
                feed.innerHTML = '';

                // –†–µ–Ω–¥–µ—Ä –Ω–∏—Ç–∫–∏ —á–∞—Å—É (—Å–ø—ñ—Ä–∞–ª—ñ)
                const linePts = [];
                const start = Date.now() - 86400000 * 2;
                for(let i=0; i<24*10; i++) linePts.push(this.getSpiralPos(start + i * 3600000));
                
                const timeline = new THREE.Line(
                    new THREE.BufferGeometry().setFromPoints(linePts),
                    new THREE.LineBasicMaterial({ color: 0x000000, transparent: true, opacity: 0.1 })
                );
                this.scene.add(timeline);

                // –ü–æ–¥—ñ—ó
                this.events.forEach(ev => {
                    this.drawEvent(ev);
                    this.addToFeed(ev);
                });

                // –ü–æ—Ç–æ—á–Ω–∏–π –º–æ–º–µ–Ω—Ç
                const nowPos = this.getSpiralPos(Date.now());
                const nowSphere = new THREE.Mesh(
                    new THREE.SphereGeometry(1),
                    new THREE.MeshBasicMaterial({ color: 0x2563eb })
                );
                nowSphere.position.copy(nowPos);
                this.scene.add(nowSphere);

                document.getElementById('event-count').innerText = `${this.events.length} –ü–û–î–Ü–ô`;
            },

            drawEvent(ev) {
                const pts = [];
                const steps = 15;
                for(let i=0; i<=steps; i++) pts.push(this.getSpiralPos(ev.start + (ev.end - ev.start)*(i/steps)));
                const tube = new THREE.TubeGeometry(new THREE.CatmullRomCurve3(pts), 20, 0.8, 8, false);
                const mat = new THREE.MeshPhongMaterial({ color: ev.color, shininess: 100 });
                this.scene.add(new THREE.Mesh(tube, mat));
            },

            addToFeed(ev) {
                const card = document.createElement('div');
                card.className = 'glass-ui p-4 rounded-2xl min-w-[160px] flex flex-col justify-between shadow-lg pointer-events-auto';
                card.style.borderLeft = `6px solid ${ev.color}`;
                const time = new Date(ev.start).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                card.innerHTML = `
                    <div class="text-[10px] font-bold opacity-40">${time}</div>
                    <div class="font-bold text-xs truncate my-1">${ev.title}</div>
                    <div class="event-tag" style="background:${ev.color}">GOOGLE SYNC</div>
                `;
                document.getElementById('google-feed').appendChild(card);
            },

            handleICS(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (f) => {
                    const blocks = f.target.result.split('BEGIN:VEVENT');
                    blocks.shift();
                    const imported = blocks.map(b => {
                        const title = (b.match(/SUMMARY:(.*)/) || [0,"–ü–æ–¥—ñ—è"])[1].trim();
                        const start = this.parseICS(b.match(/DTSTART[:;](.*)/));
                        const end = this.parseICS(b.match(/DTEND[:;](.*)/));
                        
                        // –õ–æ–≥—ñ–∫–∞ –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è –∫–æ–ª—å–æ—Ä—É –∑–∞ –≤–∞—à–∏–º –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–º
                        let color = this.catColors.default;
                        const t = title.toLowerCase();
                        if(t.includes('work') || t.includes('break')) color = this.catColors.work;
                        else if(t.includes('analytica')) color = this.catColors.analytica;
                        else if(t.includes('meds')) color = this.catColors.meds;
                        else if(t.includes('—Å–æ–Ω')) color = this.catColors.sleep;

                        return { id: Math.random(), title, start, end, color };
                    }).filter(ev => ev.start);

                    this.events = [...this.events, ...imported];
                    this.save(); this.refresh(); this.focusNow();
                };
                reader.readAsText(file);
            },

            parseICS(m) {
                if(!m) return null;
                const d = m[1].replace(/[^0-9T]/g, '');
                return new Date(`${d.slice(0,4)}-${d.slice(4,6)}-${d.slice(6,8)}T${d.slice(9,11)}:${d.slice(11,13)}:00`).getTime();
            },

            focusNow() {
                const target = this.getSpiralPos(Date.now());
                this.controls.target.lerp(target, 0.1);
                this.camera.position.lerp(new THREE.Vector3(target.x + 40, target.y + 20, target.z + 40), 0.1);
            },

            save() { localStorage.setItem('flip_v16', JSON.stringify(this.events)); },
            load() { const d = localStorage.getItem('flip_v16'); if(d) this.events = JSON.parse(d); },
            clearAll() { if(confirm("–°–∫–∏–Ω—É—Ç–∏ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—é?")) { localStorage.clear(); this.events = []; this.refresh(); } },
            importTrigger() { document.getElementById('ics-input').click(); },
            animate() { requestAnimationFrame(() => this.animate()); this.controls.update(); this.renderer.render(this.scene, this.camera); }
        };

        core.init();
    </script>
</body>
</html>
