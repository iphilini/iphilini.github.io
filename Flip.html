<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FLIP! v15.0 Prime Sync</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; background: #fdfdfd; font-family: sans-serif; overflow: hidden; }
        .ui-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.05); }
        .scroll-hide::-webkit-scrollbar { display: none; }
        .event-card { border-left: 5px solid #3b82f6; transition: 0.2s; }
        .event-card:active { transform: scale(0.98); background: #f1f5f9; }
    </style>
</head>
<body>

    <div id="canvas-container" class="fixed inset-0"></div>

    <div class="relative z-10 pointer-events-none h-screen flex flex-col p-4">
        <header class="flex justify-between items-start pointer-events-auto">
            <div class="ui-panel p-4 flex items-center gap-4">
                <h1 class="font-bold text-blue-600 text-xl tracking-tighter">FLIP! <span class="text-xs text-gray-400">v15</span></h1>
                <div id="clock" class="text-sm font-mono bg-gray-100 px-2 py-1 rounded">00:00</div>
            </div>
            <div class="flex gap-2">
                <button onclick="core.triggerImport()" class="ui-panel w-12 h-12 flex items-center justify-center text-xl shadow-lg">üì•</button>
                <button onclick="core.focusNow()" class="ui-panel w-12 h-12 flex items-center justify-center text-xl shadow-lg">üéØ</button>
            </div>
        </header>

        <div class="mt-4 pointer-events-auto overflow-y-auto max-h-[35vh] space-y-2 scroll-hide" id="event-feed">
            </div>

        <div class="mt-auto pointer-events-auto space-y-3">
            <div class="ui-panel p-4 space-y-4">
                <div class="flex justify-between items-center text-[10px] uppercase font-bold text-gray-400">
                    <span>–î—ñ–∞–ø–∞–∑–æ–Ω –°–ø—ñ—Ä–∞–ª—ñ</span>
                    <button onclick="core.clearData()" class="text-red-400">–û—á–∏—Å—Ç–∏—Ç–∏</button>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <input type="date" id="date-from" class="bg-gray-50 p-2 rounded-lg text-xs" onchange="core.refresh()">
                    <input type="date" id="date-to" class="bg-gray-50 p-2 rounded-lg text-xs" onchange="core.refresh()">
                </div>
                <input type="range" id="zoom-spiral" min="5" max="30" value="15" class="w-full" oninput="core.refresh()">
            </div>
            <button onclick="core.addManual()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold shadow-xl active:scale-95 transition">+ –°–¢–í–û–†–ò–¢–ò –ü–û–î–Ü–Æ</button>
        </div>
    </div>

    <input type="file" id="file-input" class="hidden" accept=".ics">

    <script>
        const core = {
            events: [],
            colors: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4'],
            
            init() {
                this.setupThree();
                this.load();
                this.refresh();
                this.animate();
                this.initDates();
                document.getElementById('file-input').addEventListener('change', (e) => this.handleICS(e));
                setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }, 1000);
            },

            setupThree() {
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 2000);
                this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.setPixelRatio(window.devicePixelRatio);
                document.getElementById('canvas-container').appendChild(this.renderer.domElement);
                this.controls = new THREE.OrbitControls(this.camera, this.renderer.domElement);
                this.controls.enableDamping = true;
                this.camera.position.set(40, 40, 40);
            },

            getPos(time) {
                const now = new Date();
                const dayZero = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
                const diff = (time - dayZero) / 86400000;
                
                const radius = parseFloat(document.getElementById('zoom-spiral').value);
                const angle = diff * Math.PI * 2;
                return new THREE.Vector3(Math.cos(angle) * radius, diff * 15, Math.sin(angle) * radius);
            },

            refresh() {
                while(this.scene.children.length > 0) this.scene.remove(this.scene.children[0]);
                const feed = document.getElementById('event-feed');
                feed.innerHTML = '';

                // –†–µ–Ω–¥–µ—Ä –†–æ–∑–º—ñ—Ç–∫–∏ –°–ø—ñ—Ä–∞–ª—ñ
                const linePts = [];
                const startDay = new Date(document.getElementById('date-from').value).getTime();
                const endDay = new Date(document.getElementById('date-to').value).getTime();
                
                for(let t = startDay; t <= endDay; t += 3600000) {
                    const p = this.getPos(t);
                    linePts.push(p);
                    if(new Date(t).getHours() === 0) { // –ü–æ—á–∞—Ç–æ–∫ –¥–Ω—è
                        const ring = new THREE.Mesh(new THREE.TorusGeometry(parseFloat(document.getElementById('zoom-spiral').value), 0.05, 8, 64), new THREE.MeshBasicMaterial({color: 0xeeeeee}));
                        ring.position.y = p.y; ring.rotation.x = Math.PI/2;
                        this.scene.add(ring);
                    }
                }
                this.scene.add(new THREE.Line(new THREE.BufferGeometry().setFromPoints(linePts), new THREE.LineBasicMaterial({color: 0xcccccc})));

                // –†–µ–Ω–¥–µ—Ä –ü–æ–¥—ñ–π
                this.events.forEach(ev => {
                    if(ev.start >= startDay && ev.start <= endDay) {
                        this.drawEvent(ev);
                        this.addToFeed(ev);
                    }
                });

                // –ú–∞—Ä–∫–µ—Ä "–ó–ê–†–ê–ó"
                const nowPos = this.getPos(Date.now());
                const marker = new THREE.Mesh(new THREE.SphereGeometry(0.8), new THREE.MeshBasicMaterial({color: 0x3b82f6}));
                marker.position.copy(nowPos);
                this.scene.add(marker);
            },

            drawEvent(ev) {
                const pts = [];
                const steps = 20;
                for(let i=0; i<=steps; i++) pts.push(this.getPos(ev.start + (ev.end - ev.start) * (i/steps)));
                const tube = new THREE.TubeGeometry(new THREE.CatmullRomCurve3(pts), 32, 0.7, 8, false);
                this.scene.add(new THREE.Mesh(tube, new THREE.MeshBasicMaterial({color: ev.color})));
            },

            addToFeed(ev) {
                const card = document.createElement('div');
                card.className = 'ui-panel p-4 event-card pointer-events-auto';
                card.style.borderLeftColor = ev.color;
                const timeStr = new Date(ev.start).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                card.innerHTML = `<div class="flex justify-between"><div><div class="font-bold text-sm">${ev.title}</div><div class="text-[10px] text-gray-400">${timeStr}</div></div><div class="text-[10px] opacity-30">GOOGLE</div></div>`;
                document.getElementById('event-feed').appendChild(card);
            },

            handleICS(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (f) => {
                    const content = f.target.result;
                    const blocks = content.split('BEGIN:VEVENT');
                    blocks.shift();
                    const newEvents = blocks.map(b => {
                        const title = (b.match(/SUMMARY:(.*)/) || [0,"–ü–æ–¥—ñ—è"])[1].trim();
                        const start = this.parseDate(b.match(/DTSTART[:;](.*)/));
                        const end = this.parseDate(b.match(/DTEND[:;](.*)/));
                        const hash = title.length % 7;
                        return { id: Math.random(), title, start, end, color: this.colors[hash] };
                    }).filter(ev => ev.start && ev.end);
                    
                    this.events = [...this.events, ...newEvents];
                    this.save(); this.refresh(); this.focusNow();
                    alert(`–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω–æ ${newEvents.length} –ø–æ–¥—ñ–π –∑ –ö–∞–ª–µ–Ω–¥–∞—Ä—è`);
                };
                reader.readAsText(file);
            },

            parseDate(m) {
                if(!m) return null;
                const r = m[1].replace(/[^0-9T]/g, '');
                return new Date(`${r.slice(0,4)}-${r.slice(4,6)}-${r.slice(6,8)}T${r.slice(9,11)}:${r.slice(11,13)}:00`).getTime();
            },

            initDates() {
                const n = new Date();
                const d1 = new Date(n.getFullYear(), n.getMonth(), n.getDate() - 1);
                const d2 = new Date(n.getFullYear(), n.getMonth(), n.getDate() + 7);
                document.getElementById('date-from').value = d1.toISOString().split('T')[0];
                document.getElementById('date-to').value = d2.toISOString().split('T')[0];
            },

            focusNow() {
                const target = this.getPos(Date.now());
                this.controls.target.lerp(target, 0.1);
                this.camera.position.set(target.x + 40, target.y + 20, target.z + 40);
            },

            triggerImport() { document.getElementById('file-input').click(); },
            save() { localStorage.setItem('flip_v15', JSON.stringify(this.events)); },
            load() { const d = localStorage.getItem('flip_v15'); if(d) this.events = JSON.parse(d); },
            clearData() { if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ –ø–æ–¥—ñ—ó?")) { localStorage.clear(); this.events = []; this.refresh(); } },
            animate() { requestAnimationFrame(() => this.animate()); this.controls.update(); this.renderer.render(this.scene, this.camera); }
        };

        core.init();
    </script>
</body>
</html>
