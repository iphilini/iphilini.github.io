<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FLIP! v20.0 Quantum Helix</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&display=swap');
        body { margin: 0; background: #08090a; color: #f8fafc; font-family: 'Space Grotesk', sans-serif; overflow: hidden; }
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(20px) saturate(150%); border: 1px solid rgba(255,255,255,0.1); }
        .accent-glow { text-shadow: 0 0 15px rgba(59, 130, 246, 0.5); }
        #canvas-container { position: absolute; inset: 0; z-index: 1; }
        ::-webkit-scrollbar { width: 0px; }
        .event-node { transition: 0.4s cubic-bezier(0.2, 1, 0.3, 1); border-left: 4px solid #3b82f6; }
        .event-node:hover { background: rgba(59, 130, 246, 0.1); transform: translateX(8px); }
    </style>
</head>
<body>

    <div id="canvas-container"></div>

    <div class="relative z-10 pointer-events-none h-screen flex flex-col p-6 overflow-hidden">
        
        <header class="flex justify-between items-start pointer-events-auto">
            <div class="glass p-5 rounded-[2rem] shadow-2xl">
                <div class="flex items-center gap-3">
                    <div class="w-2 h-2 bg-blue-500 rounded-full animate-ping"></div>
                    <h1 class="text-2xl font-bold tracking-tighter accent-glow uppercase">Helix OS <span class="text-blue-500 opacity-50">v20</span></h1>
                </div>
                <div id="clock" class="text-3xl font-light mt-1 tracking-widest text-slate-400">00:00:00</div>
                <div class="text-[10px] font-bold text-blue-400/50 mt-2 tracking-[0.3em] uppercase">Temporal Sync: Optimal</div>
            </div>
            
            <div class="flex gap-3">
                <button onclick="core.importTrigger()" class="glass w-16 h-16 rounded-3xl flex items-center justify-center text-2xl hover:bg-blue-600 transition-all duration-500">ðŸ“¥</button>
                <button onclick="core.focusNow()" class="glass w-16 h-16 rounded-3xl flex items-center justify-center text-2xl hover:bg-slate-700 transition-all">ðŸŽ¯</button>
            </div>
        </header>

        <div class="flex-1 flex gap-6 my-6 overflow-hidden">
            <aside class="w-96 flex flex-col pointer-events-auto overflow-hidden">
                <div class="glass flex-1 rounded-[2.5rem] p-6 flex flex-col overflow-hidden shadow-inner">
                    <div class="flex justify-between items-center mb-6">
                        <span class="text-xs font-bold text-slate-500 uppercase">Stream</span>
                        <div class="flex gap-2">
                            <div class="w-2 h-2 rounded-full bg-slate-700"></div>
                            <div class="w-2 h-2 rounded-full bg-slate-700"></div>
                        </div>
                    </div>
                    <div id="event-stream" class="flex-1 overflow-y-auto space-y-3 pr-2">
                        </div>
                </div>
            </aside>

            <div class="flex-1 flex flex-col justify-end items-end pointer-events-none">
                <div class="glass p-6 rounded-[2rem] pointer-events-auto mb-4 w-72">
                    <label class="text-[10px] font-bold text-slate-500 block mb-3 uppercase tracking-widest">Helix Expansion</label>
                    <input type="range" id="helix-zoom" min="5" max="60" value="25" class="w-full h-1 bg-slate-800 rounded-lg appearance-none cursor-pointer accent-blue-500" oninput="core.refresh()">
                    <div class="flex justify-between mt-4 text-[10px] font-bold">
                        <span class="text-slate-500">PAST</span>
                        <span class="text-blue-500">NOW</span>
                        <span class="text-slate-500">FUTURE</span>
                    </div>
                </div>
            </div>
        </div>

        <footer class="flex justify-center pointer-events-auto">
            <div class="glass px-10 py-5 rounded-full flex gap-10 items-center shadow-2xl border-blue-500/20">
                <button onclick="core.openEditor()" class="text-sm font-bold hover:text-blue-400 transition">ADD EVENT</button>
                <div class="w-[1px] h-6 bg-slate-800"></div>
                <button onclick="core.toggleGrid()" class="text-sm font-bold hover:text-blue-400 transition">TOGGLE GRID</button>
                <div class="w-[1px] h-6 bg-slate-800"></div>
                <button onclick="core.clearAll()" class="text-sm font-bold text-red-500/50 hover:text-red-400 transition">PURGE</button>
            </div>
        </footer>
    </div>

    <div id="modal" class="fixed inset-0 z-[100] bg-black/60 backdrop-blur-md opacity-0 pointer-events-none transition-opacity duration-500 flex items-center justify-center">
        <div class="glass w-full max-w-lg p-10 rounded-[3rem] shadow-[0_0_100px_rgba(59,130,246,0.1)]">
            <h2 class="text-2xl font-bold mb-6">Define Invariant</h2>
            <div class="space-y-6">
                <input id="ev-title" type="text" placeholder="Event Title" class="w-full bg-slate-900/50 border border-slate-800 p-4 rounded-2xl outline-none focus:border-blue-500 transition">
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="text-[10px] text-slate-500 ml-2 uppercase">Arrival</label>
                        <input id="ev-start" type="datetime-local" class="w-full bg-slate-900/50 border border-slate-800 p-4 rounded-2xl text-xs">
                    </div>
                    <div class="space-y-2">
                        <label class="text-[10px] text-slate-500 ml-2 uppercase">Departure</label>
                        <input id="ev-end" type="datetime-local" class="w-full bg-slate-900/50 border border-slate-800 p-4 rounded-2xl text-xs">
                    </div>
                </div>
                <div class="flex gap-4 pt-4">
                    <button onclick="core.closeEditor()" class="flex-1 p-5 rounded-2xl font-bold bg-slate-800">CANCEL</button>
                    <button onclick="core.saveEvent()" class="flex-1 p-5 rounded-2xl font-bold bg-blue-600 shadow-lg shadow-blue-500/20">COMMIT</button>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="ics-file" class="hidden" accept=".ics">

    <script>
        const core = {
            events: [],
            editingId: null,
            showGrid: true,

            init() {
                this.setupThree();
                this.load();
                this.refresh();
                this.animate();
                this.startTime();
                document.getElementById('ics-file').addEventListener('change', (e) => this.handleICS(e));
                
                // Raycasting (Interact with 3D nodes)
                window.addEventListener('mousedown', (e) => this.onRaycast(e));
            },

            setupThree() {
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 1, 5000);
                this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.setPixelRatio(window.devicePixelRatio);
                document.getElementById('canvas-container').appendChild(this.renderer.domElement);
                
                this.controls = new THREE.OrbitControls(this.camera, this.renderer.domElement);
                this.controls.enableDamping = true;
                this.camera.position.set(100, 80, 100);

                const pointLight = new THREE.PointLight(0x3b82f6, 1, 500);
                this.scene.add(new THREE.AmbientLight(0xffffff, 0.4), pointLight);
            },

            getSpiralPos(time) {
                const day = 86400000;
                const now = new Date();
                const zero = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
                const progress = (time - zero) / day;
                
                const radius = parseFloat(document.getElementById('helix-zoom').value);
                const angle = progress * Math.PI * 2;
                return new THREE.Vector3(
                    Math.cos(angle) * radius,
                    progress * 25, // Vertical density
                    Math.sin(angle) * radius
                );
            },

            refresh() {
                while(this.scene.children.length > 1) this.scene.remove(this.scene.children[1]);
                const stream = document.getElementById('event-stream');
                stream.innerHTML = '';

                // Render Background Grid
                if(this.showGrid) {
                    const gridPts = [];
                    const start = Date.now() - 86400000 * 2;
                    for(let i=0; i<24*7; i++) gridPts.push(this.getSpiralPos(start + i * 3600000));
                    const gridLine = new THREE.Line(
                        new THREE.BufferGeometry().setFromPoints(gridPts),
                        new THREE.LineBasicMaterial({ color: 0x1e293b, transparent: true, opacity: 0.5 })
                    );
                    this.scene.add(gridLine);
                }

                // Render Invariants (Events)
                this.events.sort((a,b) => a.start - b.start).forEach(ev => {
                    this.drawHelixEvent(ev);
                    this.addToStream(ev);
                });

                // Present Node
                const nowPos = this.getSpiralPos(Date.now());
                const nowHalo = new THREE.Mesh(
                    new THREE.TorusGeometry(parseFloat(document.getElementById('helix-zoom').value), 0.1, 16, 100),
                    new THREE.MeshBasicMaterial({ color: 0x3b82f6, transparent: true, opacity: 0.3 })
                );
                nowHalo.position.y = nowPos.y; nowHalo.rotation.x = Math.PI/2;
                this.scene.add(nowHalo);
            },

            drawHelixEvent(ev) {
                const pts = [];
                for(let i=0; i<=30; i++) pts.push(this.getSpiralPos(ev.start + (ev.end - ev.start)*(i/30)));
                const tube = new THREE.TubeGeometry(new THREE.CatmullRomCurve3(pts), 40, 1.2, 12, false);
                const mat = new THREE.MeshPhongMaterial({ 
                    color: ev.color || '#3b82f6', 
                    emissive: ev.color || '#3b82f6', 
                    emissiveIntensity: 0.2,
                    shininess: 100
                });
                const mesh = new THREE.Mesh(tube, mat);
                mesh.userData = { id: ev.id };
                this.scene.add(mesh);
            },

            addToStream(ev) {
                const div = document.createElement('div');
                div.className = 'glass p-5 rounded-3xl event-node pointer-events-auto';
                div.style.borderLeftColor = ev.color;
                const time = new Date(ev.start).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <span class="text-[10px] font-black text-blue-500 uppercase tracking-tighter">${time}</span>
                        <div class="w-2 h-2 rounded-full bg-blue-500 shadow-[0_0_8px_rgba(59,130,246,1)]"></div>
                    </div>
                    <div class="text-sm font-bold mt-1 text-slate-200">${ev.title}</div>
                `;
                div.onclick = () => this.openEditor(ev.id);
                document.getElementById('event-stream').appendChild(div);
            },

            // Logic Core
            handleICS(e) {
                const reader = new FileReader();
                reader.onload = (f) => {
                    const blocks = f.target.result.split('BEGIN:VEVENT');
                    blocks.shift();
                    const imported = blocks.map(b => {
                        const title = (b.match(/SUMMARY:(.*)/) || [0,"Untitled"])[1].trim();
                        const start = this.parseDate(b.match(/DTSTART[:;](.*)/));
                        const end = this.parseDate(b.match(/DTEND[:;](.*)/));
                        return { id: Math.random(), title, start, end, color: this.getAutoColor(title) };
                    }).filter(ev => ev.start);
                    this.events = [...this.events, ...imported];
                    this.save(); this.refresh(); this.focusNow();
                };
                reader.readAsText(e.target.files[0]);
            },

            getAutoColor(t) {
                const s = t.toLowerCase();
                if(s.includes('work')) return '#f59e0b';
                if(s.includes('meds')) return '#ef4444';
                if(s.includes('analytica')) return '#3b82f6';
                return '#94a3b8';
            },

            parseDate(m) {
                if(!m) return null;
                const r = m[1].replace(/[^0-9T]/g, '');
                return new Date(`${r.slice(0,4)}-${r.slice(4,6)}-${r.slice(6,8)}T${r.slice(9,11)}:${r.slice(11,13)}:00`).getTime();
            },

            saveEvent() {
                const ev = {
                    id: this.editingId || Date.now(),
                    title: document.getElementById('ev-title').value,
                    start: new Date(document.getElementById('ev-start').value).getTime(),
                    end: new Date(document.getElementById('ev-end').value).getTime(),
                    color: this.getAutoColor(document.getElementById('ev-title').value)
                };
                if(this.editingId) this.events = this.events.filter(e => e.id !== this.editingId);
                this.events.push(ev);
                this.save(); this.refresh(); this.closeEditor();
            },

            onRaycast(e) {
                const mouse = new THREE.Vector2((e.clientX/window.innerWidth)*2-1, -(e.clientY/window.innerHeight)*2+1);
                const ray = new THREE.Raycaster();
                ray.setFromCamera(mouse, this.camera);
                const hits = ray.intersectObjects(this.scene.children);
                if(hits.length > 0 && hits[0].object.userData.id) this.openEditor(hits[0].object.userData.id);
            },

            startTime() {
                setInterval(() => {
                    document.getElementById('clock').innerText = new Date().toLocaleTimeString('uk-UA', {hour12: false});
                }, 1000);
            },

            openEditor(id = null) {
                this.editingId = id;
                const m = document.getElementById('modal');
                if(id) {
                    const ev = this.events.find(e => e.id === id);
                    document.getElementById('ev-title').value = ev.title;
                    document.getElementById('ev-start').value = new Date(ev.start - (new Date().getTimezoneOffset()*60000)).toISOString().slice(0,16);
                    document.getElementById('ev-end').value = new Date(ev.end - (new Date().getTimezoneOffset()*60000)).toISOString().slice(0,16);
                }
                m.classList.remove('pointer-events-none'); m.classList.add('opacity-100');
            },

            closeEditor() {
                const m = document.getElementById('modal');
                m.classList.add('pointer-events-none'); m.classList.remove('opacity-100');
            },

            focusNow() {
                const target = this.getSpiralPos(Date.now());
                this.controls.target.lerp(target, 0.1);
                this.camera.position.lerp(new THREE.Vector3(target.x+100, target.y+50, target.z+100), 0.1);
            },

            save() { localStorage.setItem('flip_v20', JSON.stringify(this.events)); },
            load() { const d = localStorage.getItem('flip_v20'); if(d) this.events = JSON.parse(d); },
            toggleGrid() { this.showGrid = !this.showGrid; this.refresh(); },
            clearAll() { if(confirm("Destroy all temporal nodes?")) { this.events = []; this.save(); this.refresh(); }},
            importTrigger() { document.getElementById('ics-file').click(); },
            animate() { requestAnimationFrame(() => this.animate()); this.controls.update(); this.renderer.render(this.scene, this.camera); }
        };

        core.init();
    </script>
</body>
</html>
