<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FLIP! v13.0 Nebula</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&display=swap');
        body { margin: 0; background: #050505; color: #fff; font-family: 'Space+Grotesk', sans-serif; overflow: hidden; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .ui-node { pointer-events: auto; transition: all 0.3s ease; }
        .ui-node:active { scale: 0.9; }
    </style>
</head>
<body>

    <div id="canvas-container" class="fixed inset-0"></div>

    <div class="fixed inset-0 z-10 pointer-events-none flex flex-col justify-between p-6">
        <div class="flex justify-between items-start">
            <div class="glass p-4 rounded-3xl">
                <h1 class="text-xl font-bold tracking-tighter italic">FLIP! <span class="text-blue-500 not-italic">v13</span></h1>
                <p id="live-clock" class="text-[10px] font-medium opacity-70 tracking-widest mt-1 uppercase"></p>
            </div>
            <div class="flex gap-3">
                <button onclick="core.importClick()" class="ui-node glass w-14 h-14 rounded-full flex items-center justify-center text-xl">üìÖ</button>
                <button onclick="core.focusNow()" class="ui-node glass w-14 h-14 rounded-full flex items-center justify-center text-xl">üéØ</button>
            </div>
        </div>

        <div class="flex justify-center gap-4 mb-4">
             <button onclick="core.resetData()" class="ui-node glass px-6 py-3 rounded-2xl text-[10px] uppercase tracking-widest text-red-400">–°–∫–∏–Ω—É—Ç–∏ (Repair)</button>
        </div>
    </div>

    <input type="file" id="file-input" class="hidden" accept=".ics">

    <script>
        const core = {
            events: [],
            palette: ['#ff4d4d', '#ffaf40', '#fffa65', '#32ff7e', '#7efff5', '#18dcff', '#7d5fff', '#c56cf0'],
            
            init() {
                this.setupThree();
                this.load();
                this.renderUniverse();
                this.animate();
                this.startClock();
                
                document.getElementById('file-input').addEventListener('change', (e) => this.handleICS(e));
                window.addEventListener('resize', () => this.onResize());
                setTimeout(() => this.focusNow(), 500); // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
            },

            setupThree() {
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(55, window.innerWidth / window.innerHeight, 0.1, 3000);
                this.renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.setPixelRatio(window.devicePixelRatio);
                document.getElementById('canvas-container').appendChild(this.renderer.domElement);
                
                this.controls = new THREE.OrbitControls(this.camera, this.renderer.domElement);
                this.controls.enableDamping = true;
                this.controls.dampingFactor = 0.05;
            },

            getSpiralPos(time) {
                const now = new Date();
                const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
                const diffDays = (time - startOfDay) / 86400000;
                
                const radius = 18;
                const heightStep = 15;
                const angle = diffDays * Math.PI * 2;
                
                return new THREE.Vector3(
                    Math.cos(angle) * radius,
                    diffDays * heightStep,
                    Math.sin(angle) * radius
                );
            },

            renderUniverse() {
                while(this.scene.children.length > 0) this.scene.remove(this.scene.children[0]);

                // –û—Å–Ω–æ–≤–Ω–∞ –Ω–∏—Ç–∫–∞ —á–∞—Å—É
                const points = [];
                const now = Date.now();
                for(let i = -168; i < 504; i++) points.push(this.getSpiralPos(now + i * 3600000));
                
                const timeline = new THREE.Line(
                    new THREE.BufferGeometry().setFromPoints(points),
                    new THREE.LineBasicMaterial({ color: 0x222222, transparent: true, opacity: 0.5 })
                );
                this.scene.add(timeline);

                // –ú–∞—Ä–∫–µ—Ä "–ó–ê–†–ê–ó"
                const nowPos = this.getSpiralPos(now);
                const nowRing = new THREE.Mesh(
                    new THREE.TorusGeometry(18, 0.1, 8, 100),
                    new THREE.MeshBasicMaterial({ color: 0x3b82f6 })
                );
                nowRing.position.y = nowPos.y;
                nowRing.rotation.x = Math.PI / 2;
                this.scene.add(nowRing);

                // –†–µ–Ω–¥–µ—Ä –ø–æ–¥—ñ–π
                this.events.forEach(ev => {
                    const color = this.stringToColor(ev.title);
                    this.createEventTube(ev.start, ev.end, color);
                    
                    // –Ø–∫—â–æ –ø–æ–¥—ñ—è –ø–æ–≤—Ç–æ—Ä—é–≤–∞–Ω–∞ (–∑ Google)
                    if(ev.isRecurring) {
                        for(let i = 1; i <= 14; i++) {
                            const offset = i * 86400000;
                            this.createEventTube(ev.start + offset, ev.end + offset, color);
                        }
                    }
                });
            },

            createEventTube(start, end, color) {
                const pts = [];
                for(let i=0; i<=24; i++) pts.push(this.getSpiralPos(start + (end - start)*(i/24)));
                const tube = new THREE.TubeGeometry(new THREE.CatmullRomCurve3(pts), 40, 0.9, 10, false);
                const mesh = new THREE.Mesh(tube, new THREE.MeshBasicMaterial({ color: color }));
                this.scene.add(mesh);
            },

            stringToColor(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
                return this.palette[Math.abs(hash) % this.palette.length];
            },

            handleICS(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (f) => {
                    const content = f.target.result;
                    const blocks = content.split('BEGIN:VEVENT');
                    blocks.shift();

                    const newEvs = blocks.map(b => {
                        const title = (b.match(/SUMMARY:(.*)/) || [0,"–ü–æ–¥—ñ—è"])[1].trim();
                        const start = this.parseDate(b.match(/DTSTART[:;](.*)/));
                        const end = this.parseDate(b.match(/DTEND[:;](.*)/));
                        return { title, start, end, isRecurring: b.includes('RRULE:') };
                    }).filter(ev => ev.start && ev.end);

                    this.events = [...this.events, ...newEvs];
                    this.save();
                    this.renderUniverse();
                    this.focusNow();
                };
                reader.readAsText(file);
            },

            parseDate(m) {
                if(!m) return null;
                const raw = m[1].replace(/[^0-9T]/g, '');
                const y = raw.slice(0,4), month = raw.slice(4,6), d = raw.slice(6,8);
                const h = raw.slice(9,11), min = raw.slice(11,13);
                return new Date(`${y}-${month}-${d}T${h}:${min}:00`).getTime();
            },

            focusNow() {
                const target = this.getSpiralPos(Date.now());
                this.controls.target.lerp(target, 1);
                this.camera.position.set(target.x + 50, target.y + 30, target.z + 50);
            },

            startClock() {
                const update = () => {
                    const n = new Date();
                    document.getElementById('live-clock').innerText = n.toLocaleTimeString('uk-UA') + " ‚Ä¢ " + n.toLocaleDateString('uk-UA', {day:'numeric', month:'short'});
                };
                setInterval(update, 1000); update();
            },

            save() { localStorage.setItem('flip_v13', JSON.stringify(this.events)); },
            load() { const d = localStorage.getItem('flip_v13'); if(d) this.events = JSON.parse(d); },
            resetData() { if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ –¥–∞–Ω—ñ?")) { localStorage.clear(); location.reload(); } },
            onResize() { this.camera.aspect = window.innerWidth / window.innerHeight; this.camera.updateProjectionMatrix(); this.renderer.setSize(window.innerWidth, window.innerHeight); },
            importClick() { document.getElementById('file-input').click(); },
            animate() { requestAnimationFrame(() => this.animate()); this.controls.update(); this.renderer.render(this.scene, this.camera); }
        };

        core.init();
    </script>
</body>
</html>
