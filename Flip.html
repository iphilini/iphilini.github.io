<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FLIP! v12.5 Helix Sync</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&display=swap');
        body { margin: 0; background: #000; color: #fff; font-family: 'Space+Grotesk', sans-serif; overflow: hidden; }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .shimmer { background: linear-gradient(90deg, #60a5fa, #c084fc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    </style>
</head>
<body>

    <div id="canvas-container" class="fixed inset-0"></div>

    <div class="relative z-10 pointer-events-none h-screen flex flex-col p-5">
        <header class="flex justify-between items-start pointer-events-auto">
            <div class="glass p-3 rounded-2xl">
                <h1 class="text-xl font-bold tracking-tighter shimmer">FLIP! <span class="text-[10px] text-white/40 ml-1">v12.5</span></h1>
                <p id="info" class="text-[9px] opacity-50 uppercase mt-1">Helix Synchronization Active</p>
            </div>
            <div class="flex gap-2">
                <button onclick="core.importClick()" class="glass w-12 h-12 rounded-2xl flex items-center justify-center text-xl active:scale-90 transition">üì•</button>
                <button onclick="core.focusNow()" class="glass w-12 h-12 rounded-2xl flex items-center justify-center text-xl active:scale-90 transition">üéØ</button>
            </div>
        </header>
    </div>

    <input type="file" id="file-input" class="hidden" accept=".ics">

    <script>
        const core = {
            events: [],
            colors: ['#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6', '#ec4899', '#64748b'],
            
            init() {
                this.setupThree();
                this.load();
                this.renderAll();
                this.animate();
                document.getElementById('file-input').addEventListener('change', (e) => this.handleICS(e));
            },

            setupThree() {
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 2000);
                this.camera.position.set(40, 60, 40);
                this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                document.getElementById('canvas-container').appendChild(this.renderer.domElement);
                this.controls = new THREE.OrbitControls(this.camera, this.renderer.domElement);
                this.controls.enableDamping = true;
            },

            // –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –∫–æ–ª—å–æ—Ä—É –Ω–∞ –æ—Å–Ω–æ–≤—ñ —Ç–µ–∫—Å—Ç—É (—â–æ–± –°–Ω—ñ–¥–∞–Ω–æ–∫ –∑–∞–≤–∂–¥–∏ –±—É–≤ –æ–¥–Ω–∏–º –∫–æ–ª—å–æ—Ä–æ–º)
            stringToColor(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
                return this.colors[Math.abs(hash) % this.colors.length];
            },

            getPos(time) {
                const now = new Date();
                const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
                const diffDays = (time - startOfDay) / 86400000;
                const angle = diffDays * Math.PI * 2;
                return new THREE.Vector3(Math.cos(angle)*15, diffDays*12, Math.sin(angle)*15);
            },

            renderAll() {
                while(this.scene.children.length > 0) this.scene.remove(this.scene.children[0]);
                
                // –†–µ–Ω–¥–µ—Ä –æ—Å—ñ
                const points = [];
                const now = Date.now();
                for(let i = -48; i < 24 * 30; i++) points.push(this.getPos(now + i * 3600000));
                this.scene.add(new THREE.Line(new THREE.BufferGeometry().setFromPoints(points), new THREE.LineBasicMaterial({ color: 0x222222 })));

                this.events.forEach(ev => {
                    const color = ev.color || this.stringToColor(ev.title);
                    this.drawEvent(ev.start, ev.end, color);
                    
                    // –õ–û–ì–Ü–ö–ê –ü–û–í–¢–û–†–Ü–í: —è–∫—â–æ –≤ –Ω–∞–∑–≤—ñ —î –Ω–∞—Ç—è–∫ –Ω–∞ —Å–µ—Ä—ñ—é –∞–±–æ —Ü–µ —ñ–º–ø–æ—Ä—Ç
                    if(ev.isRecurring) {
                        for(let i=1; i<14; i++) { // –ú–∞–ª—é—î–º–æ –Ω–∞ 2 —Ç–∏–∂–Ω—ñ –≤–ø–µ—Ä–µ–¥
                            const offset = i * 86400000;
                            this.drawEvent(ev.start + offset, ev.end + offset, color);
                        }
                    }
                });
            },

            drawEvent(start, end, color) {
                const curvePts = [];
                for(let i=0; i<=32; i++) curvePts.push(this.getPos(start + (end - start)*(i/32)));
                const tube = new THREE.TubeGeometry(new THREE.CatmullRomCurve3(curvePts), 32, 0.7, 8, false);
                this.scene.add(new THREE.Mesh(tube, new THREE.MeshBasicMaterial({ color: color })));
            },

            handleICS(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (f) => {
                    const content = f.target.result;
                    const vevents = content.split('BEGIN:VEVENT');
                    vevents.shift();
                    
                    const newEvents = vevents.map(block => {
                        const title = (block.match(/SUMMARY:(.*)/) || [0,"–ë–µ–∑ –Ω–∞–∑–≤–∏"])[1].trim();
                        const start = this.parseICSDate(block.match(/DTSTART[:;](.*)/));
                        const end = this.parseICSDate(block.match(/DTEND[:;](.*)/));
                        const isRecurring = block.includes('RRULE:');
                        return { id: Math.random(), title, start, end, isRecurring };
                    }).filter(ev => ev.start && ev.end);

                    this.events = [...this.events, ...newEvents];
                    this.save();
                    this.renderAll();
                    this.focusNow();
                };
                reader.readAsText(file);
            },

            parseICSDate(match) {
                if(!match) return null;
                const d = match[1].replace(/[^0-9T]/g, ''); // –û—á–∏—Å—Ç–∫–∞ –≤—ñ–¥ TZID
                const y = d.substring(0,4), m = d.substring(4,6), day = d.substring(6,8);
                const h = d.substring(9,11), min = d.substring(11,13);
                return new Date(`${y}-${m}-${day}T${h}:${min}:00`).getTime();
            },

            focusNow() {
                const target = this.getPos(Date.now());
                this.controls.target.copy(target);
                this.camera.position.set(target.x + 30, target.y + 20, target.z + 30);
            },

            importClick() { document.getElementById('file-input').click(); },
            save() { localStorage.setItem('flip_v12_5', JSON.stringify(this.events)); },
            load() { const d = localStorage.getItem('flip_v12_5'); if(d) this.events = JSON.parse(d); },
            animate() { requestAnimationFrame(() => this.animate()); this.controls.update(); this.renderer.render(this.scene, this.camera); }
        };

        core.init();
    </script>
</body>
</html>
