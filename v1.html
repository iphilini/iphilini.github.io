<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Spiral Core v2.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style> body { margin: 0; overflow: hidden; background: #000; } </style>
</head>
<body>
    <div id="ui" class="absolute top-10 left-10 z-10 text-white pointer-events-none">
        <h1 class="text-3xl font-black tracking-tighter uppercase">Spiral Logic v2.0</h1>
        <p class="text-blue-400 font-mono" id="time-display"></p>
    </div>

    <script>
        // --- КОНФІГУРАЦІЯ ---
        const CONFIG = {
            radius: 8,
            heightPerDay: 10,
            segmentsPerDay: 120, // плавність спіралі
            daysShown: 7
        };

        // --- СЦЕНА ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        camera.position.set(15, 15, 15);

        // Світло
        scene.add(new THREE.AmbientLight(0x404040, 2));
        const light = new THREE.PointLight(0xffffff, 1);
        light.position.set(10, 20, 10);
        scene.add(light);

        // --- ФУНКЦІЯ ЧАСУ -> ПОЗИЦІЯ ---
        function getTimePos(date) {
            const now = new Date();
            const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const hoursSinceEpoch = (date - startOfToday) / 3600000;
            
            const angle = (hoursSinceEpoch / 24) * Math.PI * 2;
            const y = (hoursSinceEpoch / 24) * CONFIG.heightPerDay;
            
            return new THREE.Vector3(
                Math.cos(angle) * CONFIG.radius,
                y,
                Math.sin(angle) * CONFIG.radius
            );
        }

        // --- ГЕОМЕТРІЯ СПІРАЛІ ---
        const points = [];
        for (let i = -24; i < 24 * CONFIG.daysShown; i += 0.2) {
            const d = new Date();
            d.setHours(i, 0, 0, 0);
            points.push(getTimePos(d));
        }
        const spiralCurve = new THREE.CatmullRomCurve3(points);
        const spiralGeo = new THREE.TubeGeometry(spiralCurve, 600, 0.05, 8, false);
        const spiralMat = new THREE.MeshPhongMaterial({ color: 0x444444, transparent: true, opacity: 0.5 });
        scene.add(new THREE.Mesh(spiralGeo, spiralMat));

        // --- КІЛЬЦЕ "ЗАРАЗ" ---
        const nowRingGeo = new THREE.TorusGeometry(CONFIG.radius, 0.1, 16, 100);
        const nowRingMat = new THREE.MeshBasicMaterial({ color: 0x00ffff });
        const nowRing = new THREE.Mesh(nowRingGeo, nowRingMat);
        nowRing.rotation.x = Math.PI / 2;
        scene.add(nowRing);

        // --- ФУНКЦІЯ СТВОРЕННЯ ПОДІЇ ---
        function createEvent(start, end, color = 0x3b82f6) {
            const eventPoints = [];
            const durationHrs = (end - start) / 3600000;
            for (let i = 0; i <= durationHrs; i += 0.1) {
                const d = new Date(start.getTime() + i * 3600000);
                eventPoints.push(getTimePos(d));
            }
            const curve = new THREE.CatmullRomCurve3(eventPoints);
            const geo = new THREE.TubeGeometry(curve, 50, 0.3, 8, false);
            const mat = new THREE.MeshPhongMaterial({ color: color });
            scene.add(new THREE.Mesh(geo, mat));
        }

        // Тестова подія: сьогодні з 14:00 до 18:00
        const s = new Date(); s.setHours(14, 0, 0);
        const e = new Date(); e.setHours(18, 0, 0);
        createEvent(s, e, 0xff0066);

        // --- LOOP ---
        function animate() {
            requestAnimationFrame(animate);
            
            const now = new Date();
            const pos = getTimePos(now);
            nowRing.position.y = pos.y;
            // Корекція кута кільця, щоб воно було перпендикулярне осі (спрощено)
            
            document.getElementById('time-display').innerText = now.toLocaleString();
            
            controls.update();
            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
